<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moondream</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="title">Starting Moondreamâ€¦</div>
        <div class="sub">Launching the local server.</div>
        <div class="spinner" aria-hidden="true"></div>
        <div id="err" class="err" hidden></div>
      </div>
    </div>

    <script>
      const errEl = document.getElementById("err");

      function showErr(msg) {
        errEl.hidden = false;
        errEl.textContent = msg;
      }

      async function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      async function getPort() {
        if (!window.__TAURI__?.invoke) return null;
        try {
          return await window.__TAURI__.invoke("server_port");
        } catch {
          return null;
        }
      }

      async function waitForHealth(port, { timeoutMs = 45000 } = {}) {
        const base = `http://127.0.0.1:${port}`;
        const start = Date.now();
        // eslint-disable-next-line no-constant-condition
        while (true) {
          if (Date.now() - start > timeoutMs) return false;
          try {
            const r = await fetch(`${base}/api/health`, { cache: "no-store" });
            if (r.ok) return true;
          } catch {
            // ignore
          }
          await sleep(250);
        }
      }

      (async () => {
        // Poll the Rust side until it tells us what port it picked.
        let port = null;
        for (let i = 0; i < 200; i++) {
          port = await getPort();
          if (typeof port === "number" && port > 0) break;
          await sleep(100);
        }
        if (!port) {
          showErr(
            "Failed to start local server (missing port). If you're running a dev build, start the web server at http://localhost:3000."
          );
          return;
        }

        const ok = await waitForHealth(port);
        if (!ok) {
          showErr(
            `Local server did not become ready. Try restarting the app.\n(Waiting on http://127.0.0.1:${port})`
          );
          return;
        }

        // Navigate to the real app.
        window.location.replace(`http://127.0.0.1:${port}/`);
      })();
    </script>
  </body>
</html>


