(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{22:(e,t,r)=>{"use strict";r.d(t,{ProjectWorkspace:()=>L});var n=r(5155),i=r(2115),a=r(6878);function l(e){if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}}function o(e){let{asset:t,projectId:r,onClose:a}=e,o=!!t.mime_type&&t.mime_type.startsWith("video/"),[s,c]=(0,i.useState)(!1),[d,u]=(0,i.useState)(!!e.originRect),h=(0,i.useRef)(!1),f=(0,i.useRef)(null),m=(0,i.useRef)(null),[p,x]=(0,i.useState)(null),[w,g]=(0,i.useState)(null),[y,v]=(0,i.useState)(null),[b,j]=(0,i.useState)("translate(0px,0px) scale(1,1)"),_=(0,i.useRef)(null),M=(0,i.useMemo)(()=>(function(e){if(!e)return[];try{let t=JSON.parse(e);if(!Array.isArray(t))return[];return t.map(e=>String(e)).filter(Boolean)}catch{return[]}})(t.ai_tags_json),[t.ai_tags_json]),N=(0,i.useRef)(null),[z,C]=(0,i.useState)(null),R=(0,i.useMemo)(()=>w?p?.find(e=>e.tag===w)??null:null,[p,w]);(0,i.useEffect)(()=>{let e=window.setTimeout(()=>c(!0),0);return()=>window.clearTimeout(e)},[]),(0,i.useEffect)(()=>()=>{f.current&&window.clearTimeout(f.current),m.current&&window.clearTimeout(m.current)},[]);let k=(0,i.useCallback)(()=>{if(h.current)return;h.current=!0,m.current&&(window.clearTimeout(m.current),m.current=null),c(!1);let t=e.originRect??null;if(!t)return void a();let r=(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return _.current;let t=e.getBoundingClientRect();return t.width>2&&t.height>2?{left:t.left,top:t.top,width:t.width,height:t.height}:_.current})();if(!r)return void a();u(!0),v({position:"fixed",left:r.left,top:r.top,width:r.width,height:r.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1}),j("translate(0px, 0px) scale(1, 1)");let n=t.left+t.width/2,i=t.top+t.height/2,l=r.left+r.width/2,o=r.top+r.height/2,s=n-l,d=i-o,p=t.width/r.width,x=t.height/r.height;requestAnimationFrame(()=>{requestAnimationFrame(()=>j(`translate(${s}px, ${d}px) scale(${p}, ${x})`))}),f.current=window.setTimeout(()=>a(),260)},[a,e.originRect]);(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&k()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[k]),(0,i.useEffect)(()=>{let e=!1;return x(null),g(null),fetch(`/api/projects/${r}/assets/${t.id}/segments`).then(e=>e.ok?e.json():null).then(t=>{if(e)return;let r=t?.segments??null;x(Array.isArray(r)?r:[])}).catch(()=>{e||x([])}),()=>{e=!0}},[t.id,r]);let T=(0,i.useCallback)(()=>{let e=N.current;if(!e)return;let r=e.clientWidth,n=e.clientHeight,i=e.naturalWidth||t.width||0,a=e.naturalHeight||t.height||0;if(!(r>2&&n>2&&i>2&&a>2))return void C(null);let l=Math.min(r/i,n/a),o=i*l,s=a*l;C({offsetX:(r-o)/2,offsetY:(n-s)/2,drawW:o,drawH:s,scale:l})},[t.height,t.width]);return(0,i.useEffect)(()=>{T();let e=()=>T();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[T]),(0,i.useEffect)(()=>{let e=N.current;if(!e)return;let t=new ResizeObserver(()=>T());return t.observe(e),()=>t.disconnect()},[T]),(0,i.useEffect)(()=>{let t=e.originRect??null;if(!t){u(!1),v(null);return}let r=window.setTimeout(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return void u(!1);let r=e.getBoundingClientRect();if(!(r.width>2&&r.height>2))return void u(!1);let n={left:r.left,top:r.top,width:r.width,height:r.height};_.current=n,v({position:"fixed",left:n.left,top:n.top,width:n.width,height:n.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1});let i=t.left+t.width/2,a=t.top+t.height/2,l=n.left+n.width/2,o=n.top+n.height/2,s=t.width/n.width,c=t.height/n.height;j(`translate(${i-l}px, ${a-o}px) scale(${s}, ${c})`),requestAnimationFrame(()=>{requestAnimationFrame(()=>j("translate(0px, 0px) scale(1, 1)"))}),m.current=window.setTimeout(()=>{u(!1),v(null),m.current=null},260)},0);return()=>window.clearTimeout(r)},[e.originRect,t.id]),(0,n.jsxs)("div",{className:"fixed inset-0 z-[9999] bg-black transition-opacity duration-200 "+(s?"opacity-100":"opacity-0"),onClick:()=>k(),"aria-modal":"true",role:"dialog",children:[y?(0,n.jsx)("div",{style:{...y,transform:b},children:o?(0,n.jsx)("video",{src:t.storage_url,className:"h-full w-full object-contain",muted:!0,playsInline:!0}):(0,n.jsx)("img",{src:t.storage_url,alt:"",className:"h-full w-full object-contain",draggable:!1})}):null,(0,n.jsxs)("div",{className:"flex h-full w-full flex-col md:flex-row md:gap-0 transition-transform duration-200 ease-out "+(s?"scale-100":"scale-[0.985]"),onClick:e=>e.stopPropagation(),children:[(0,n.jsx)("div",{className:"flex min-h-0 flex-1 items-center justify-center p-4 md:p-8",children:(0,n.jsxs)("div",{className:"relative h-full w-full max-w-[min(1100px,100%)]",children:[o?(0,n.jsx)("video",{"data-asset-lightbox-target":"true",src:t.storage_url,controls:!0,playsInline:!0,className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100")}):(0,n.jsx)("img",{"data-asset-lightbox-target":"true",ref:N,src:t.storage_url,alt:t.original_name||"asset",className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100"),draggable:!1,onLoad:()=>T()}),!d&&R&&z?(0,n.jsxs)("div",{className:"pointer-events-none absolute inset-0",children:[R.svg&&R.svg.trim().startsWith("<svg")?(0,n.jsx)("img",{alt:"",draggable:!1,src:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(R.svg)}`,style:{position:"absolute",left:z.offsetX,top:z.offsetY,width:z.drawW,height:z.drawH,opacity:.22,mixBlendMode:"screen",filter:"drop-shadow(0px 0px 10px rgba(124, 58, 237, 0.65))"}}):null,l(R.bboxJson).map((e,t)=>{let r=e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5,i=r?e.x*z.drawW:e.x*z.scale,a=r?e.y*z.drawH:e.y*z.scale,l=r?e.w*z.drawW:e.w*z.scale,o=r?e.h*z.drawH:e.h*z.scale;return(0,n.jsx)("div",{style:{position:"absolute",left:z.offsetX+i,top:z.offsetY+a,width:l,height:o},className:"rounded-sm border-2 border-violet-400/90 bg-violet-500/10 shadow-[0_0_18px_rgba(124,58,237,0.55)]"},`${R.tag}-${t}`)})]}):null]})}),(0,n.jsxs)("aside",{className:"w-full shrink-0 border-t border-white/10 bg-zinc-950/60 backdrop-blur md:w-[420px] md:border-l md:border-t-0",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-3 border-b border-white/10 p-4",children:[(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("div",{className:"truncate text-sm font-medium text-zinc-100",children:t.original_name}),(0,n.jsxs)("div",{className:"truncate text-xs text-zinc-400",children:[t.width&&t.height?`${t.width}\xd7${t.height}`:"",t.mime_type?t.width&&t.height?` \xb7 ${t.mime_type}`:t.mime_type:"",Number.isFinite(t.byte_size)?` \xb7 ${function(e){if(!Number.isFinite(e)||e<=0)return"0 B";let t=["B","KB","MB","GB","TB"],r=Math.min(t.length-1,Math.floor(Math.log(e)/Math.log(1024))),n=e/Math.pow(1024,r);return`${n.toFixed(n>=10||0===r?0:1)} ${t[r]}`}(t.byte_size)}`:""]})]}),(0,n.jsx)("button",{onClick:()=>k(),className:"inline-flex h-10 w-10 shrink-0 items-center justify-center rounded-full border border-white/10 bg-black/30 text-zinc-200 hover:bg-black/50 focus:outline-none focus:ring-2 focus:ring-violet-400/50","aria-label":"Close",children:(0,n.jsx)("span",{"aria-hidden":"true",className:"text-lg leading-none",children:"\xd7"})})]}),(0,n.jsx)("div",{className:"max-h-[45vh] overflow-auto p-4 md:max-h-none md:h-[calc(100%-57px)]",children:(0,n.jsxs)("div",{className:"space-y-5",children:[(0,n.jsx)("section",{children:(0,n.jsxs)("div",{className:"mt-2 space-y-2 text-sm text-zinc-100",children:[t.ai_caption?(0,n.jsx)("div",{className:"rounded-lg border border-white/10 bg-black/20 p-3 text-sm text-zinc-100",children:t.ai_caption}):null,M.length?(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:M.slice(0,64).map(e=>(0,n.jsx)("div",{className:"rounded-full border border-white/10 bg-black/20 px-2 py-1 text-xs text-zinc-200",children:e},e))}):null]})}),(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"Segments"}),(0,n.jsx)("div",{className:"mt-2",children:null===p?(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"Loadingâ€¦"}):p.length?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"mb-2 flex items-center justify-between gap-2",children:[(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"Click a tag to highlight it on the image."}),w?(0,n.jsx)("button",{onClick:()=>g(null),className:"rounded-md border border-white/10 bg-black/30 px-2 py-1 text-[11px] text-zinc-200 hover:bg-black/50",children:"Clear"}):null]}),(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:p.slice(0,80).map(e=>{let t=e.tag===w;return(0,n.jsx)("button",{type:"button",onClick:()=>g(t=>t===e.tag?null:e.tag),className:"rounded-full border px-2 py-1 text-xs "+(t?"border-violet-400/60 bg-violet-500/15 text-zinc-100":"border-white/10 bg-black/20 text-zinc-200 hover:bg-black/30"),title:e.updatedAt,children:e.tag},e.tag)})}),!w||R?.svg||l(R?.bboxJson??null).length?null:(0,n.jsxs)("div",{className:"mt-2 text-xs text-zinc-500",children:["No overlay data cached for ",(0,n.jsx)("span",{className:"text-zinc-300",children:w}),"."]})]}):(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"No cached segments."})})]}),(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"File"}),(0,n.jsxs)("div",{className:"mt-2 space-y-2 text-xs text-zinc-300",children:[(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"Created:"})," ",t.created_at]}),t.ai_updated_at?(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"AI Updated:"})," ",t.ai_updated_at]}):null]})]})]})})]})]})]})}let s="projectDrafts",c=new Map,d=new Set,u=null;function h(){return u||(u=new Promise((e,t)=>{let r=indexedDB.open("moondream",1);r.onupgradeneeded=()=>{let e=r.result;e.objectStoreNames.contains(s)||e.createObjectStore(s,{keyPath:"projectId"})},r.onsuccess=()=>e(r.result),r.onerror=()=>{let e=r.error??Error("indexedDB.open failed");u=null,t(e)}}))}function f(e){return new Promise((t,r)=>{e.oncomplete=()=>t(),e.onerror=()=>r(e.error??Error("IDB transaction failed")),e.onabort=()=>r(e.error??Error("IDB transaction aborted"))})}async function m(e){var t,r;let n,i,a=c.get(e)??null;if(d.has(e))return a;let l=(await h()).transaction(s,"readonly"),o=l.objectStore(s).get(e),u=await new Promise((e,t)=>{o.onsuccess=()=>e(o.result??null),o.onerror=()=>t(o.error??Error("IDB get failed"))});if(await f(l),d.add(e),!u)return a;if(!a)return c.set(e,u),u;let m=(t=u,n=(r=a).canvas??t.canvas,i=r.view??t.view,{...t,...r,projectId:r.projectId,updatedAt:Math.max(t.updatedAt,r.updatedAt),canvas:n,view:i,dirtyCanvas:null===r.canvas?t.dirtyCanvas:r.dirtyCanvas,dirtyView:null===r.view?t.dirtyView:r.dirtyView});return c.set(e,m),m}async function p(e){c.set(e.projectId,e);let t=(await h()).transaction(s,"readwrite");t.objectStore(s).put(e),await f(t)}let x=new Map,w=globalThis.requestIdleCallback??((e,t)=>globalThis.setTimeout(()=>e({didTimeout:!0,timeRemaining:()=>0}),Math.max(0,t?.timeout??200)));async function g(e){let t=x.get(e);if(t&&!t.inFlight){t.inFlight=!0;try{let r=t.next;if(await p(r),t.inFlight=!1,t.next===r){t.resolve(r),x.delete(e);return}t.scheduled||(t.scheduled=!0,w(()=>{let t=x.get(e);t&&(t.scheduled=!1,g(e))},{timeout:t.timeoutMs}))}catch(r){t.inFlight=!1,t.reject(r),x.delete(e)}}}async function y(e,t){return await function(e,t,r){let n={...c.get(e)??{projectId:e,updatedAt:0,canvas:null,view:null,dirtyCanvas:!1,dirtyView:!1},...t,projectId:e,updatedAt:t.updatedAt??Date.now()};c.set(e,n);let i=x.get(e);if(i)i.next=n,i.timeoutMs=r?.timeoutMs??i.timeoutMs;else{let t,a,l=new Promise((e,r)=>{t=e,a=r});i={next:n,timeoutMs:r?.timeoutMs??300,scheduled:!1,inFlight:!1,promise:l,resolve:t,reject:a},x.set(e,i)}return i.scheduled||i.inFlight||(i.scheduled=!0,w(()=>{(i=x.get(e))&&(i.scheduled=!1),g(e)},{timeout:i.timeoutMs})),i.promise}(e,t,{timeoutMs:300})}let v="#0a0a0a",b={bgHex:592139,bgAlpha:.88,strokeHex:0xffffff,strokeAlpha:.1,shadeAlpha:.28};function j(e,t,r){return Math.max(t,Math.min(r,e))}function _(e){for(let t of[e?.source?.resource,e?.source?.resource?.source,e?.source?.resource?.domElement,e?.baseTexture?.resource,e?.baseTexture?.resource?.source,e?.baseTexture?.resource?.domElement,e?.baseTexture?.source?.resource,e?.baseTexture?.source?.resource?.source])if(t){if("undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement)return t;if("undefined"!=typeof HTMLVideoElement&&t?.source instanceof HTMLVideoElement)return t.source;if("undefined"!=typeof HTMLVideoElement&&t?.domElement instanceof HTMLVideoElement)return t.domElement;if("undefined"!=typeof HTMLVideoElement&&t?.element instanceof HTMLVideoElement)return t.element}return null}function M(e,t){e.clear(),e.roundRect(0,0,220,160,10),e.fill({color:t.bgHex,alpha:t.bgAlpha}),e.stroke({color:t.strokeHex,width:1,alpha:t.strokeAlpha})}function N(e,t,r,n){let i=e.texture?.orig?.width??0,a=e.texture?.orig?.height??0;if(i<=0||a<=0||t<=0||r<=0)return null;let l=Math.abs(i*(e.scale?.x??1)),o=Math.abs(a*(e.scale?.y??1));if(l<=0||o<=0)return null;let s=e.rotation??0,c=Math.abs(Math.cos(s)),d=Math.abs(Math.sin(s)),u=c*l+d*o,h=d*l+c*o;if(u<=0||h<=0)return null;let f=j(n,.1,.98);return j(Math.min(t*f/u,r*f/h),.01,1)}function z(e){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)return;let n=Math.min(22,t/2,r/2),i=e.__roundMask;i||((i=new a.A1g).eventMode="none",i.visible=!0,e.__roundMask=i,e.addChild(i),e.mask=i),i.clear(),i.roundRect(-t/2,-r/2,t,r,n),i.fill(0xffffff)}function C(e,t,r,n,i){e.clear();let a=j(i,0,1),l=.1+.06*a,o=6+4*a,s=18+10*a;for(let i=0;i<8;i++){let a=i/7,c=s*(.2+1.05*a),d=(1-a)*(1-a)*l*.45,u=Math.min(n+c,(t+2*c)/2,(r+2*c)/2);e.roundRect(-t/2-c+o,-r/2-c+o,t+2*c,r+2*c,u),e.fill({color:0,alpha:d})}}function R(e){let t=e.projectId,r=e.initialObjects,l=e.initialView??null,s=e.onObjectsChange,c=(0,i.useRef)(null),d=(0,i.useRef)(null),u=(0,i.useRef)(null),h=(0,i.useRef)(null),f=(0,i.useRef)(new Map),p=(0,i.useRef)(new Map),x=(0,i.useRef)(new Map),w=(0,i.useRef)(new Map),g=(0,i.useRef)(new Map),R=(0,i.useRef)(new Set),k=(0,i.useRef)(new Map),T=(0,i.useRef)(null),S=(0,i.useRef)(!1),I=(0,i.useRef)(null),A=(0,i.useRef)(new Map),E=(0,i.useRef)([]),F=(0,i.useRef)(new Map),L=(0,i.useRef)(new Map),$=(0,i.useRef)(new Set),D=(0,i.useRef)(null),B=(0,i.useRef)(new a.bRX(.5,.5)),P=(0,i.useRef)(null),O=(0,i.useRef)(null),V=(0,i.useRef)(null),U=(0,i.useRef)(null),H=(0,i.useRef)({}),X=(0,i.useRef)(null),W=(0,i.useRef)(null),q=(0,i.useRef)(null),J=(0,i.useRef)(null),Y=(0,i.useRef)(-1),K=(0,i.useRef)(null),G=()=>{K.current=null},Q=(e,t)=>{let r=u.current;if(!r)return!1;let n={x:r.position.x,y:r.position.y,zoom:r.scale.x||1},i=j(t?.durationMs??280,80,1200);return .01>Math.abs(n.x-e.x)&&.01>Math.abs(n.y-e.y)&&1e-6>Math.abs(n.zoom-e.zoom)?(r.position.set(e.x,e.y),r.scale.set(e.zoom),t?.onComplete?.()):K.current={startMs:performance.now(),durationMs:i,from:n,to:e,onComplete:t?.onComplete},!0},Z=(e,t)=>Math.hypot(e.x-t.x,e.y-t.y,(e.zoom-t.zoom)*650),[ee,et]=(0,i.useState)(r),[er,en]=(0,i.useState)(e.initialAssets),[ei,ea]=(0,i.useState)([]),[el,eo]=(0,i.useState)(null),[es,ec]=(0,i.useState)(null),ed=(0,i.useRef)(null),[eu,eh]=(0,i.useState)(!0),[ef,em]=(0,i.useState)(!1),[ep,ex]=(0,i.useState)(()=>({online:!0,dirtyCanvas:!1,dirtyView:!1,syncing:!1})),ew=e=>{let t=d.current,r=u.current;if(!t||!r)return!1;let n=r.scale.x||1,i=j(Math.max(1.6*n,N(e,t.renderer.width,t.renderer.height,.88)??null??0,n),.01,1),a=e.position,l=t.renderer.width/2-a.x*i,o=t.renderer.height/2-a.y*i;return G(),Q({x:l,y:o,zoom:i},{durationMs:320,onComplete:()=>{let e=u.current;e&&(eP({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eO())}}),!0},eg=(0,i.useRef)({canvas:!1,view:!1}),ey=(0,i.useRef)(null),ev=(0,i.useRef)(null),eb=(0,i.useRef)(null),[ej,e_]=(0,i.useState)(null),eM=(e,t,r)=>{let n=d.current,i=h.current,a=D.current;if(!n||!i||!a)return;let l=Math.max(1,n.renderer.width),o=Math.max(1,n.renderer.height),s=j(e/l,0,1),c=j(t/o,0,1);B.current.set(s,c),a.active=!0,a.timeSec=0,a.uniforms.uniforms.uTime=0,a.uniforms.uniforms.uCenter.set(s,c),a.uniforms.uniforms.uAspect=l/o,a.uniforms.uniforms.uShapeAspect=j(Number(r?.shapeAspect??1)||1,.05,20),a.uniforms.uniforms.uShapeRotation=Number(r?.shapeRotation??0)||0,i.filters&&0!==i.filters.length?i.filters.includes(a.filter)||(i.filters=[a.filter,...i.filters]):i.filters=[a.filter]},eN=(e,t)=>{let r=P.current;if(!r||r.fired||r.objectId!==e)return;let n=Number(t?.orig?.width??0),i=Number(t?.orig?.height??0);n>0&&i>0&&(r.fired=!0,eM(r.rx,r.ry,{shapeAspect:n/i,shapeRotation:0}))},ez=(0,i.useRef)(r);(0,i.useEffect)(()=>{ez.current=ee},[ee]);let eC=(0,i.useRef)(b),eR=(0,i.useRef)(b.shadeAlpha);(0,i.useEffect)(()=>{E.current=ei},[ei]),(0,i.useEffect)(()=>en(e.initialAssets),[e.initialAssets]),(0,i.useEffect)(()=>{et(r),ed.current=null,eg.current={canvas:!1,view:!1},eh(!0),ex(e=>({...e,dirtyCanvas:!1,dirtyView:!1,syncing:!1}))},[t]),(0,i.useEffect)(()=>{if(!eu)return void em(!1);let e=window.setTimeout(()=>em(!0),150);return()=>window.clearTimeout(e)},[eu,t]);let ek=e=>{eg.current.canvas!==e&&(eg.current.canvas=e,ex(t=>({...t,dirtyCanvas:e})))},eT=e=>{eg.current.view!==e&&(eg.current.view=e,ex(t=>({...t,dirtyView:e})))};(0,i.useEffect)(()=>{let e=()=>ex(e=>({...e,online:navigator.onLine}));return e(),window.addEventListener("online",e),window.addEventListener("offline",e),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",e)}},[]),(0,i.useEffect)(()=>{let e=!1;return(async()=>{let n=!1;try{let i=await m(t);if(e)return;if(!i){ek(!1),eT(!1),y(t,{canvas:r,view:l,dirtyCanvas:!1,dirtyView:!1}).catch(()=>{});return}ek(!!i.dirtyCanvas),eT(!!i.dirtyView),n=(i.dirtyCanvas||i.dirtyView)&&"undefined"!=typeof navigator&&navigator.onLine;let a=Math.max(0,...r.map(e=>Date.parse(e.updated_at||e.created_at||"")).filter(e=>Number.isFinite(e)));if(i.canvas&&(i.dirtyCanvas||i.updatedAt>a)&&(et(i.canvas),s?.(i.canvas)),i.view){ed.current=i.view;let e=u.current;if(e){e.position.set(i.view.world_x,i.view.world_y);let t=Number.isFinite(i.view.zoom)?i.view.zoom:1;e.scale.set(j(t,.01,1))}}}catch{}finally{if(!e&&n)try{await Promise.race([eS(),new Promise(e=>window.setTimeout(e,250))])}catch{}e||eh(!1)}})(),()=>{e=!0}},[t,r,s]);let eS=async()=>{if(ey.current)return ey.current;if(!("undefined"!=typeof navigator?navigator.onLine:ep.online))return;let e=(async()=>{ex(e=>({...e,syncing:!0}));try{let e=await m(t);if(!e)return;let r=!!e.dirtyCanvas,n=!!e.dirtyView;if(r&&e.canvas)try{let n=await fetch(`/api/projects/${t}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:e.canvas})});if(!n.ok)throw Error(`canvas_sync_failed:${n.status}`);r=!1,await y(t,{canvas:e.canvas,dirtyCanvas:!1}).catch(()=>{})}catch{}if(n&&e.view)try{let r=await fetch(`/api/projects/${t}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.view)});if(!r.ok)throw Error(`view_sync_failed:${r.status}`);n=!1,await y(t,{view:e.view,dirtyView:!1}).catch(()=>{})}catch{}ek(r),eT(n)}finally{ex(e=>({...e,syncing:!1})),ey.current=null}})();return ey.current=e,e};(0,i.useEffect)(()=>{if(!ep.online||!ep.dirtyCanvas&&!ep.dirtyView)return;eS();let e=window.setInterval(()=>void eS(),3e3);return()=>window.clearInterval(e)},[t,ep.online,ep.dirtyCanvas,ep.dirtyView]);let eI=(0,i.useRef)(null),eA=(0,i.useRef)(null),eE=(0,i.useRef)(null),eF=(0,i.useRef)(null),eL=(0,i.useRef)(null),e$=e=>{!s||(eL.current=e,eF.current||(eF.current=window.setTimeout(()=>{eF.current=null;let e=eL.current;eL.current=null,e&&s?.(e)},0)))},eD=r=>{ev.current&&window.clearTimeout(ev.current),ev.current=window.setTimeout(()=>{y(t,{canvas:r,dirtyCanvas:!0}).catch(()=>{})},40),ek(!0),eI.current&&window.clearTimeout(eI.current),eI.current=window.setTimeout(async()=>{try{let n=await fetch(`/api/projects/${e.projectId}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:r})});if(!n.ok)throw Error(`canvas_save_failed:${n.status}`);y(t,{canvas:r,dirtyCanvas:!1}).catch(()=>{}),ek(!1)}catch{ek(!0)}},250),eO()},eB=async r=>{ev.current&&(window.clearTimeout(ev.current),ev.current=null),y(t,{canvas:r,dirtyCanvas:!0}).catch(()=>{}),ek(!0),eI.current&&(window.clearTimeout(eI.current),eI.current=null);try{let n=await fetch(`/api/projects/${e.projectId}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:r})});if(!n.ok)throw Error(`canvas_save_failed:${n.status}`);y(t,{canvas:r,dirtyCanvas:!1}).catch(()=>{}),ek(!1)}catch{ek(!0)}},eP=r=>{eb.current&&window.clearTimeout(eb.current),eb.current=window.setTimeout(()=>{y(t,{view:r,dirtyView:!0}).catch(()=>{})},60),eT(!0),eA.current&&window.clearTimeout(eA.current),eA.current=window.setTimeout(async()=>{try{let n=await fetch(`/api/projects/${e.projectId}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!n.ok)throw Error(`view_save_failed:${n.status}`);y(t,{view:r,dirtyView:!1}).catch(()=>{}),eT(!1)}catch{eT(!0)}},250)},eO=()=>{eE.current&&window.clearTimeout(eE.current),eE.current=window.setTimeout(async()=>{let t=d.current,r=O.current;if(!t||!r)return;let n=r.content,i=r.spriteById,l=1/0,o=1/0,s=-1/0,c=-1/0;for(let e of f.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;l=Math.min(l,e.position.x-n),s=Math.max(s,e.position.x+n),o=Math.min(o,e.position.y-i),c=Math.max(c,e.position.y+i)}if(!Number.isFinite(l)||!Number.isFinite(o)||!Number.isFinite(s)||!Number.isFinite(c))return;let u=Math.max(Math.max(1,s-l),Math.max(1,c-o)),h=Math.max(24,.08*u),m=(l+s)/2,p=(o+c)/2,x=new Set;for(let e of f.current.values()){let t=e.__objectId;if(!t)continue;let r=e.texture,l=r?.orig?.width??0,o=r?.orig?.height??0;if(l<=0||o<=0)continue;x.add(t);let s=i.get(t);s?s.texture!==r&&(s.texture=r):((s=new a.kxk(r)).anchor.set(.5),s.eventMode="none",n.addChild(s),i.set(t,s)),s.position.copyFrom(e.position),s.scale.copyFrom(e.scale),s.rotation=e.rotation,s.alpha=1}for(let[e,t]of i.entries())x.has(e)||(t.destroy({children:!0,texture:!1}),i.delete(e));let w=256/(u+2*h);n.scale.set(w),n.position.set(128-m*w,128-p*w),t.renderer.render({container:r.root,target:r.rt,clear:!0,clearColor:657930});let g=t.renderer.extract.canvas({target:r.rt}),y=null;if(g?.convertToBlob?(y=await g.convertToBlob({type:"image/webp",quality:.75}).catch(()=>null))||(y=await g.convertToBlob({type:"image/png"}).catch(()=>null)):g?.toBlob&&(y=await new Promise(e=>g.toBlob(e,"image/webp",.75))??await new Promise(e=>g.toBlob(e,"image/png"))),!y)return;let v=await y.arrayBuffer();await fetch(`/api/projects/${e.projectId}/preview`,{method:"PUT",headers:{"Content-Type":y.type||"image/webp"},body:v}).catch(()=>{})},1200)},eV=(0,i.useMemo)(()=>{let e=new Map;for(let t of er)e.set(t.id,t);return e},[er]);(0,i.useMemo)(()=>new Set(ei),[ei]),1===ei.length&&ei[0];let eU=e=>{let t=T.current;if(t!==e){if(T.current=e,t){let e=k.current.get(t);e&&(e.visible=!1)}if(e){let t=k.current.get(e);t&&(t.visible=!0)}}},eH=()=>{for(let[e,t]of F.current.entries()){try{t.destroy({children:!0})}catch{}F.current.delete(e)}},eX=(e,t)=>{let r=j(t,0,1);for(let t of e){let e=L.current.get(t)??{current:0,target:0};e.target=r,L.current.set(t,e),$.current.add(t)}},eW=(t,r)=>{let n=f.current.get(t);if(!n)return;let i=e.highlightOverlay;if(!i||i.assetId!==r)return;let l=n.texture?.orig?.width??0,o=n.texture?.orig?.height??0;if((l<=0||o<=0)&&eV.get(r)){let e=eV.get(r);l=e.width??0,o=e.height??0}if(l<=0||o<=0)return;let s=new a.mcf;if(s.eventMode="none",i.svg&&i.svg.trim().startsWith("<svg")){let e=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(i.svg)}`,t=a.gPd.from(e),r=new a.kxk(t);r.anchor.set(.5),r.width=l,r.height=o,r.alpha=.22,r.tint=6333946,r.blendMode="screen",s.addChild(r)}let c=(e=>{if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}})(i.bboxJson);if(c.length){let e=c.every(e=>e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5),t=new a.A1g;for(let r of(t.eventMode="none",c)){let n=e?r.x*l:r.x,i=e?r.y*o:r.y,a=e?r.w*l:r.w,s=e?r.h*o:r.h,c=-l/2+n,d=-o/2+i;t.rect(c,d,a,s),t.fill({color:6333946,alpha:.1}),t.stroke({color:6333946,alpha:.85,width:3})}s.addChild(t)}n.addChild(s),F.current.set(t,s)};(0,i.useEffect)(()=>{eH();let t=e.highlightOverlay;if(t){for(let e of ee)"image"===e.type&&e.asset_id&&e.asset_id===t.assetId&&eW(e.id,e.asset_id);return()=>{eH()}}},[e.highlightOverlay,ee,eV]),(0,i.useEffect)(()=>{let e=e=>{let t=document.activeElement,r=t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable);if(!r&&("r"===e.key||"R"===e.key)){let t=d.current,r=u.current;if(!t)return;e.preventDefault();let n=1===E.current.length?E.current[0]:null;if(n&&r){let e=f.current.get(n);if(e){let t=e.getGlobalPosition(new a.bRX),r=e.texture?.orig?.width??0,n=e.texture?.orig?.height??0,i=Math.abs(e.scale.x)||1,l=Math.abs(e.scale.y)||1,o=r>0&&n>0?r*i/Math.max(1e-6,n*l):1;eM(t.x,t.y,{shapeAspect:o,shapeRotation:e.rotation});return}}eM(t.renderer.width/2,t.renderer.height/2);return}if(!r&&("0"===e.key||"Digit0"===e.code||"Numpad0"===e.code)){let t=d.current,r=u.current;if(!t||!r)return;e.preventDefault();let n=new a.bRX(t.renderer.width/2,t.renderer.height/2),i=r.toLocal(n),l=j(.1,.01,1),o=n.x-i.x*l,s=n.y-i.y*l;G(),Q({x:o,y:s,zoom:l},{durationMs:260,onComplete:()=>{let e=u.current;e&&(eP({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eO())}});return}if(!r&&S.current&&("Space"===e.code||" "===e.key||"Spacebar"===e.key)){let t=d.current,r=u.current;if(!t||!r)return;let n=1===E.current.length?E.current[0]:null;if(!n)return;let i=f.current.get(n);if(!i)return;let l=r.scale.x||1,o=j(Math.max(1.6*l,N(i,t.renderer.width,t.renderer.height,.88)??null??0,l),.01,1),s=i.position,c=t.renderer.width/2-s.x*o,h=t.renderer.height/2-s.y*o;e.preventDefault();let m={x:r.position.x,y:r.position.y,zoom:r.scale.x||1},p={x:c,y:h,zoom:o},x=new a.bRX(t.renderer.width/2,t.renderer.height/2),w=r.toLocal(x),g=j(.1,.01,1),y={x:x.x-w.x*g,y:x.y-w.y*g,zoom:g},v=Z(m,p)<=Z(m,y)?y:p;G(),Q(v,{durationMs:320,onComplete:()=>{let e=u.current;e&&(eP({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eO())}});return}if("Backspace"!==e.key&&"Delete"!==e.key||r)return;let n=E.current;if(!n||0===n.length)return;e.preventDefault();let i=ez.current??[],l=new Set(n),o=i.filter(e=>l.has(e.id)&&"image"===e.type);if(o.length>0){let e=new Set;for(let t of o)t.asset_id&&e.add(t.asset_id);let t=new Set;for(let e of i)!l.has(e.id)&&"image"===e.type&&e.asset_id&&t.add(e.asset_id);let r=[...e].filter(e=>!t.has(e)),n=r.length>0?`Delete ${o.length} image(s) from the board?

This will also permanently delete ${r.length} asset(s) from the project because nothing else is using them.`:`Delete ${o.length} image(s) from the board?`;if(!window.confirm(n))return}ea([]);let s=null,c=[];et(e=>{let t=new Set(n),r=e.filter(e=>!t.has(e.id)),i=new Set;for(let r of e)t.has(r.id)&&"image"===r.type&&r.asset_id&&i.add(r.asset_id);let a=new Set;for(let e of r)"image"===e.type&&e.asset_id&&a.add(e.asset_id);return c=[...i].filter(e=>!a.has(e)),s=r,e$(r),r}),window.setTimeout(async()=>{if(s&&(await eB(s),eO(),c.length)){for(let e of c)await fetch(`/api/assets/${e}`,{method:"DELETE"}).catch(()=>{});en(e=>e.filter(e=>!c.includes(e.id)))}},0)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{let e=c.current;if(!e||d.current)return;let t=new a.lgM;return d.current=t,(async()=>{e.style.backgroundColor=v,await t.init({resizeTo:e,background:v,antialias:!0,autoDensity:!0,resolution:window.devicePixelRatio||1}),e.appendChild(t.canvas);let r=new a.mcf;h.current=r,r.filterArea=t.screen,t.stage.addChild(r);let n=new a.mcf;n.sortableChildren=!0,u.current=n,r.addChild(n);let i=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;

    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}`,o=`
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;

uniform float uTime;
uniform vec2 uCenter;     // 0..1 within filterArea (screen-space)
uniform float uAmplitude; // UV offset scale
uniform float uFrequency; // wave frequency
uniform float uSpeed;     // ring expansion speed (in UV/sec)
uniform float uWidth;     // ring thickness (in UV)
uniform float uDecay;     // spatial decay
uniform float uAspect;    // width/height
uniform float uShapeAspect;   // image aspect (w/h) for elliptical ripples
uniform float uShapeRotation; // radians (align ellipse to image rotation)
uniform float uDuration;  // seconds

float heightAt(float dist, float radius, float w, float timeFade, float distFade)
{
    float x = dist - radius;

    // Front band: a smooth "impact ring".
    float frontBand = exp(-(x * x) / (w * w));

    // Behind band: trailing ripples that decay behind the front.
    float behindBand = step(x, 0.0) * exp(x / (w * 2.0));

    // Ahead of the front, fade out quickly.
    float aheadFade = smoothstep(w * 3.0, 0.0, x);

    float band = (0.25 * frontBand + 0.75 * behindBand) * aheadFade;

    // Two harmonics reads as "watery" vs a single sine.
    float phase = x * uFrequency;
    float wave = sin(phase) + 0.35 * sin(phase * 2.15 + 1.3);

    // Global gain (keeps the effect subtle even with higher frequency content).
    return wave * band * timeFade * distFade * 0.35;
}

void main()
{
    vec2 uv = vTextureCoord;
    vec2 pUv = uv - uCenter;
    // Convert to screen-corrected space (so circles are circles on screen).
    vec2 pScreen = pUv;
    pScreen.x *= uAspect;

    // Rotate into the image-aligned frame.
    float cs = cos(uShapeRotation);
    float sn = sin(uShapeRotation);
    mat2 rot = mat2(cs, -sn, sn, cs);
    vec2 pr = rot * pScreen;

    // Elliptical metric based on the image aspect ratio (w/h).
    float sAspect = max(uShapeAspect, 0.0001);
    vec2 pm = vec2(pr.x / sAspect, pr.y);
    float dist = length(pm);

    float timeFade = clamp(1.0 - (uTime / max(uDuration, 0.001)), 0.0, 1.0);
    float distFade = exp(-uDecay * dist);

    float radius = uTime * uSpeed;
    float w = max(uWidth, 0.0005);

    // Radial direction in UV space for an ellipse:
    // - compute direction in metric space (pm), then map back to UV.
    vec2 dm = dist > 0.00001 ? (pm / dist) : vec2(0.0, 0.0);
    vec2 dr = vec2(dm.x * sAspect, dm.y); // undo metric scaling (back to rotated screen space)
    mat2 rotInv = mat2(cs, sn, -sn, cs);
    vec2 dScreen = rotInv * dr;
    vec2 dir = dScreen;
    dir.x /= max(uAspect, 0.00001);
    float dirLen = length(dir);
    dir = dirLen > 0.00001 ? (dir / dirLen) : vec2(0.0, 0.0);

    // Finite-difference slope -> "refraction normal" feel.
    float eps = 0.004;
    float h0 = heightAt(dist, radius, w, timeFade, distFade);
    float h1 = heightAt(dist + eps, radius, w, timeFade, distFade);
    float h2 = heightAt(max(0.0, dist - eps), radius, w, timeFade, distFade);
    float dh = (h1 - h2) / (2.0 * eps);
    float dhClamped = clamp(dh, -1.0, 1.0);
    float hClamped = clamp(h0, -1.0, 1.0);

    // Refraction: use slope + a tiny rotational component.
    vec2 perp = vec2(-dir.y, dir.x);
    vec2 disp = (dir * dhClamped + perp * (hClamped * 0.08)) * uAmplitude;

    vec2 uv2 = uv + disp;
    uv2 = clamp(uv2, vec2(0.0), vec2(1.0));

    finalColor = texture(uTexture, uv2);
}`,s=new a.k2S({uTime:{value:0,type:"f32"},uCenter:{value:new a.bRX(.5,.5),type:"vec2<f32>"},uAmplitude:{value:.0026,type:"f32"},uFrequency:{value:28,type:"f32"},uSpeed:{value:.36,type:"f32"},uWidth:{value:.18,type:"f32"},uDecay:{value:1.4,type:"f32"},uAspect:{value:1,type:"f32"},uShapeAspect:{value:1,type:"f32"},uShapeRotation:{value:0,type:"f32"},uDuration:{value:1.85,type:"f32"}});D.current={filter:new a.dJT({glProgram:a.M2g.from({vertex:i,fragment:o,name:"workspace-ripple-filter"}),resources:{rippleUniforms:s},padding:0}),uniforms:s,active:!1,timeSec:0};let c=new a.mcf,d=new a.mcf;c.addChild(d),O.current={rt:a.Y7R.create({width:256,height:256,resolution:1}),root:c,content:d,spriteById:new Map};let m=ed.current??l;if(m){n.position.set(m.world_x,m.world_y);let e=Number.isFinite(m.zoom)?m.zoom:1;n.scale.set(j(e,.01,1))}let x=new a.mcf;x.eventMode="none",x.visible=!1,x.alpha=0,t.stage.addChild(x);let w=new a.A1g;M(w,eC.current),x.addChild(w);let y=new a.A1g;y.roundRect(0,0,220,160,10),y.fill(0xffffff),y.visible=!0,x.addChild(y);let b=new a.mcf;b.mask=y,x.addChild(b);let _=new a.mcf;b.addChild(_);let z=new a.A1g;b.addChild(z);let F=new a.A1g;b.addChild(F);let B=new a.A1g;b.addChild(B),W.current={container:x,bg:w,items:_,spriteById:new Map,shade:z,overlay:F,viewport:B,showUntilMs:0,targetAlpha:0},M(w,eC.current);let P=new a.mcf;P.zIndex=1e9,V.current=P,n.addChild(P);let Q=new a.A1g;U.current=Q,P.addChild(Q);let Z=new a.A1g;Z.eventMode="none",Z.zIndex=0x3b9ac9ff,X.current=Z,n.addChild(Z);let ee=e=>{let t=new a.A1g;return t.eventMode="static",t.cursor="nwse-resize",t.__handle={corner:e},P.addChild(t),t};H.current={tl:ee("tl"),tr:ee("tr"),br:ee("br"),bl:ee("bl")};let er=new a.bRX(0,0),en=(e,r)=>{let n=t.canvas.getBoundingClientRect(),i=(e-n.left)*t.renderer.width/n.width,l=(r-n.top)*t.renderer.height/n.height;return new a.bRX(i,l)},ei=(e,t)=>({tl:new a.bRX(-e/2,-t/2),tr:new a.bRX(e/2,-t/2),br:new a.bRX(e/2,t/2),bl:new a.bRX(-e/2,t/2)});t.canvas.addEventListener("pointerdown",e=>{S.current=!0,G(),t.canvas.setPointerCapture(e.pointerId),eU(null),er=en(e.clientX,e.clientY);let r=t.renderer.events.rootBoundary.hitTest(er.x,er.y);J.current={pointerId:e.pointerId,button:e.button??0,startRx:er.x,startRy:er.y,moved:!1,objectId:r&&!r.__handle&&r.__objectId?r.__objectId:null,isHandle:!!(r&&r.__handle),shift:e.shiftKey};let n=1===E.current.length?E.current[0]:null;if(r&&r.__handle&&n){let e=r.__handle.corner,t=f.current.get(n),i=t?.texture?.orig?.width??0,l=t?.texture?.orig?.height??0;if(t&&i>0&&l>0){let r=ei(i,l),o="tl"===e?"br":"tr"===e?"bl":"br"===e?"tl":"tr",s=r[e],c=r[o];q.current={kind:"resize",objectId:n,corner:e,fixedWorld:new a.bRX(t.position.x+t.scale.x*c.x,t.position.y+t.scale.y*c.y),localFixed:c,localHandle:s,baseW:i,baseH:l};return}}if(r&&r.__objectId){let t,n=r.__objectId,i=e.shiftKey,a=E.current??[];if(i){let e=new Set(a);e.has(n)?e.delete(n):e.add(n),t=Array.from(e)}else t=[n];ea(t),et(e=>{let r=function(e,t){if(!t.length)return e;let r=new Set(t),n=[...e].sort((e,t)=>e.z_index!==t.z_index?e.z_index-t.z_index:e.id.localeCompare(t.id)),i=[...n.filter(e=>!r.has(e.id)),...n.filter(e=>r.has(e.id))],a=new Date().toISOString();return i.map((e,t)=>e.z_index===t?e:{...e,z_index:t,updated_at:a})}(e,t);return e$(r),eD(r),r});let l=E.current,o=l&&l.length>0&&(i||l.includes(n))&&l.includes(n)?l:[n];q.current={kind:"move",objectIds:t.length?t:o,last:er},eX(t.length?t:o,1);return}e.shiftKey||ea([]),q.current={kind:"pan",last:er}}),t.canvas.addEventListener("pointermove",e=>{S.current=!0;let r=en(e.clientX,e.clientY),i=J.current;i&&i.pointerId===e.pointerId&&!i.moved&&Math.hypot(r.x-i.startRx,r.y-i.startRy)>6&&(i.moved=!0);let a=q.current;if(!a){let e=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(e&&e.__handle)return void eU(null);let n=(e&&e.__objectId?e.__objectId:null)??null;return void(n&&R.current.has(n)?eU(n):eU(null))}if("pan"===a.kind){el();let e=r.x-a.last.x,t=r.y-a.last.y;n.position.x+=e,n.position.y+=t,q.current={kind:"pan",last:r},eP({world_x:n.position.x,world_y:n.position.y,zoom:n.scale.x});return}if("move"===a.kind){let e=a.objectIds.map(e=>[e,f.current.get(e)]).filter(([,e])=>!!e);if(0===e.length)return;let t=r.x-a.last.x,i=r.y-a.last.y,l=1/(n.scale.x||1);for(let[r,n]of e){n.position.x+=t*l,n.position.y+=i*l;let e=p.current.get(r);e&&(e.position.x=n.position.x,e.position.y=n.position.y)}q.current={kind:"move",objectIds:a.objectIds,last:r},et(t=>{let r=new Map(e),n=t.map(e=>{let t=r.get(e.id);return t?{...e,x:t.position.x,y:t.position.y,updated_at:new Date().toISOString()}:e});return e$(n),eD(n),n});return}if("resize"===a.kind){let e=f.current.get(a.objectId);if(!e)return;let t=n.toLocal(r),i=t.x-a.fixedWorld.x,l=t.y-a.fixedWorld.y,o=a.localHandle.x-a.localFixed.x,s=a.localHandle.y-a.localFixed.y,c=i/o,d=l/s,u=Math.max(Math.abs(c),Math.abs(d));c=u,d=u,c=Math.max(.05,c),d=Math.max(.05,d),e.scale.set(c,d),e.position.x=a.fixedWorld.x-c*a.localFixed.x,e.position.y=a.fixedWorld.y-d*a.localFixed.y,et(t=>{let r=t.map(t=>t.id===a.objectId?{...t,x:e.position.x,y:e.position.y,scale_x:e.scale.x,scale_y:e.scale.y,width:a.baseW*e.scale.x,height:a.baseH*e.scale.y,updated_at:new Date().toISOString()}:t);return e$(r),eD(r),r})}}),t.canvas.addEventListener("pointerup",e=>{let t=q.current;t&&"move"===t.kind&&eX(t.objectIds,0),q.current=null,eO();let r=J.current;if(J.current=null,!r||r.moved||0!==r.button||r.shift||!r.objectId)return;let n=u.current;if(!n||(n.scale.x||1)>.18)return;let i=ez.current.find(e=>e.id===r.objectId);if(!i||"image"!==i.type||!i.asset_id)return;let a=f.current.get(r.objectId);a&&ew(a)&&(Y.current=performance.now())}),t.canvas.addEventListener("wheel",e=>{let t;S.current=!0,G(),e.preventDefault(),el();let r=en(e.clientX,e.clientY),i=n.toLocal(r),a=Math.pow(1.16,(e.deltaY>0?-1:1)*j(Math.abs(1===e.deltaMode?16*e.deltaY:2===e.deltaMode?800*e.deltaY:e.deltaY)/100,.35,6)),l=n.scale.x,o=.12+(t=j(a>1?(1-l)/.99:(l-.01)/.99,0,1))*t*(3-2*t)*.88,s=j(l+(l*a-l)*o,.01,1);n.scale.set(s);let c=n.toLocal(r);n.position.x+=(c.x-i.x)*n.scale.x,n.position.y+=(c.y-i.y)*n.scale.y,eP({world_x:n.position.x,world_y:n.position.y,zoom:n.scale.x}),eO()},{passive:!1}),t.canvas.addEventListener("contextmenu",e=>e.preventDefault()),t.canvas.addEventListener("pointerenter",()=>{S.current=!0}),t.canvas.addEventListener("pointerleave",()=>{S.current=!1,eU(null)}),t.canvas.addEventListener("dblclick",e=>{if(q.current)return;let r=performance.now();if(r-Y.current<450)return;let n=en(e.clientX,e.clientY),i=t.renderer.events.rootBoundary.hitTest(n.x,n.y);if(!i||i.__handle)return;let a=i.__objectId;if(!a)return;let l=ez.current.find(e=>e.id===a);if(!l||"image"!==l.type||!l.asset_id)return;let o=u.current,s=o?.scale.x||1,c=f.current.get(a),d=c?N(c,t.renderer.width,t.renderer.height,.88)??null:null;if(s<(d?j(.75*d,.25,.75):.35)){c&&ew(c)&&(Y.current=r);return}let h=t.canvas.getBoundingClientRect(),m=null;if(c&&h.width>0&&h.height>0&&t.renderer.width>0&&t.renderer.height>0)try{let e=c.getBounds(),r=h.left+e.x/t.renderer.width*h.width,n=h.top+e.y/t.renderer.height*h.height,i=e.width/t.renderer.width*h.width,a=e.height/t.renderer.height*h.height;Number.isFinite(r)&&Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(a)&&i>2&&a>2&&(m={left:r,top:n,width:i,height:a})}catch{m=null}e_(m),ec(l.asset_id)});let el=()=>{let e=W.current;e&&(e.showUntilMs=performance.now()+2500,e.targetAlpha=1,e.container.visible=!0)};t.ticker.add(e=>{let i=D.current;if(i&&i.active){i.timeSec+=(e.deltaMS??16.6667)/1e3,i.uniforms.uniforms.uTime=i.timeSec,i.uniforms.uniforms.uAspect=t.renderer.width/Math.max(1,t.renderer.height);let n=Number(i.uniforms.uniforms.uDuration)||1;i.timeSec>=n&&(i.active=!1,i.timeSec=0,r.filters&&r.filters.includes(i.filter)&&(r.filters=r.filters.filter(e=>e!==i.filter)),r.filters&&0===r.filters.length&&(r.filters=[]))}let l=K.current;if(l){var o,s,c;let e,t=performance.now(),r=l.durationMs>0?(t-l.startMs)/l.durationMs:1,i=(e=j(r,0,1))*e*(3-2*e),a=(o=l.from.zoom,o+(l.to.zoom-o)*i);n.scale.set(a),n.position.x=(s=l.from.x,s+(l.to.x-s)*i),n.position.y=(c=l.from.y,c+(l.to.y-c)*i),r>=1&&(K.current=null,l.onComplete?.())}let d=$.current;if(d.size)for(let e of[...d]){let t=L.current.get(e);if(!t){d.delete(e);continue}let r=t.target-t.current;t.current+=.12*r,.001>Math.abs(r)&&(t.current=t.target,d.delete(e));let n=f.current.get(e),i=p.current.get(e);if(!n||!i)continue;let a=n.texture?.orig?.width??0,l=n.texture?.orig?.height??0;if(a<=0||l<=0)continue;let o=Math.min(22,a/2,l/2);C(i,a,l,o,t.current)}(()=>{let e=V.current,t=U.current;if(!e||!t)return;let r=H.current,n=E.current,i=1===n.length?n[0]:null,a=i?f.current.get(i):null,l=a?.texture?.orig?.width??0,o=a?.texture?.orig?.height??0;if(!a||l<=0||o<=0){e.visible=!1;return}e.visible=!0,e.position.set(a.position.x,a.position.y),e.rotation=a.rotation,e.scale.set(a.scale.x,a.scale.y),t.clear(),t.rect(-l/2,-o/2,l,o),t.stroke({width:2/Math.max(1e-4,a.scale.x),color:6333946,alpha:.9});let s=10/Math.max(1e-4,a.scale.x),c=ei(l,o);for(let e of["tl","tr","br","bl"]){let t=r[e];t&&(t.clear(),t.rect(c[e].x-s/2,c[e].y-s/2,s,s),t.fill(0xf8fafc),t.stroke({width:1/Math.max(1e-4,a.scale.x),color:2042167,alpha:.9}),t.__handle={corner:e})}})(),(()=>{let e=X.current;if(!e)return;let t=E.current;if(!t||t.length<=1)return e.clear();let r=n.scale.x||1,i=2/Math.max(1e-4,r),a=6/Math.max(1e-4,r),l=2/Math.max(1e-4,r);for(let r of(e.clear(),t)){let t=f.current.get(r);if(!t)continue;let n=t.texture?.orig?.width??0,o=t.texture?.orig?.height??0;if(n<=0||o<=0)continue;let s=n*t.scale.x/2+l,c=o*t.scale.y/2+l,d=Math.cos(t.rotation),u=Math.sin(t.rotation),h=(e,r)=>({x:t.position.x+e*d-r*u,y:t.position.y+e*u+r*d}),m=h(-s,-c),p=h(s,-c),x=h(s,c),w=h(-s,c);e.lineStyle(a,6333946,.22),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(w.x,w.y),e.lineTo(m.x,m.y),e.lineStyle(i,6333946,.98),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(w.x,w.y),e.lineTo(m.x,m.y)}})(),(()=>{let e=W.current;if(!e)return;if(e.container.position.set(t.renderer.width-220-12,t.renderer.height-160-12),performance.now()>e.showUntilMs&&(e.targetAlpha=0),e.container.alpha+=(e.targetAlpha-e.container.alpha)*.18,e.container.alpha<.02&&0===e.targetAlpha){e.container.visible=!1;return}if(!e.container.visible)return;let r=n.toLocal(new a.bRX(0,0)),i=n.toLocal(new a.bRX(t.renderer.width,t.renderer.height)),l=Math.min(r.x,i.x),o=Math.max(r.x,i.x),s=Math.min(r.y,i.y),c=Math.max(r.y,i.y);for(let e of f.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;l=Math.min(l,e.position.x-n),o=Math.max(o,e.position.x+n),s=Math.min(s,e.position.y-i),c=Math.max(c,e.position.y+i)}let d=Math.max(10,.06*Math.max(o-l,c-s));l-=d,o+=d,s-=d,c+=d;let u=Math.max(1,o-l),h=Math.max(1,c-s),m=Math.min(200/u,140/h),p=10+(200-u*m)/2,x=10+(140-h*m)/2,w=e=>p+(e-l)*m,g=e=>x+(e-s)*m,y=new Set,v=new Set(E.current??[]);for(let t of f.current.values()){let r=t.__objectId;if(!r)continue;let n=t.texture,i=n?.orig?.width??0,l=n?.orig?.height??0;if(i<=0||l<=0)continue;y.add(r);let o=e.spriteById.get(r);o?o.texture!==n&&(o.texture=n):((o=new a.kxk(n)).anchor.set(.5),o.eventMode="none",e.items.addChild(o),e.spriteById.set(r,o)),o.position.set(w(t.position.x),g(t.position.y)),o.scale.set(t.scale.x*m,t.scale.y*m),o.rotation=t.rotation,o.alpha=v.has(r)?1:.92}for(let[t,r]of e.spriteById.entries())y.has(t)||(r.destroy({children:!1}),e.spriteById.delete(t));if(e.overlay.clear(),v.size>0)for(let t of(e.overlay.lineStyle(2,0xfbbf24,.95),v)){let r=f.current.get(t);if(!r)continue;let n=r.texture,i=n?.orig?.width??0,a=n?.orig?.height??0;if(i<=0||a<=0)continue;let l=i*r.scale.x*m,o=a*r.scale.y*m,s=w(r.position.x),c=g(r.position.y);e.overlay.drawRect(s-l/2,c-o/2,l,o)}e.viewport.clear();let b=w(r.x),_=g(r.y),M=w(i.x),N=g(i.y),z=Math.min(b,M),C=Math.min(_,N),R=Math.abs(M-b),k=Math.abs(N-_),T=210,S=150,I=j(z,10,210),A=j(C,10,S),F=j(z+R,10,T),L=j(C+k,10,S),$=Math.min(I,F),D=Math.min(A,L),B=Math.max(0,Math.abs(F-I)),P=Math.max(0,Math.abs(L-A));e.shade.clear(),e.shade.beginFill(0,eR.current),e.shade.drawRect(10,10,200,Math.max(0,D-10)),e.shade.drawRect(10,D+P,200,Math.max(0,S-(D+P))),e.shade.drawRect(10,D,Math.max(0,$-10),P),e.shade.drawRect($+B,D,Math.max(0,T-($+B)),P),e.shade.endFill(),e.viewport.beginFill(6333946,.07),e.viewport.drawRect($,D,B,P),e.viewport.endFill();let O=Math.max(0,B-6),V=Math.max(0,P-6);O>0&&V>0&&(e.viewport.lineStyle(6,6333946,.22),e.viewport.drawRect($+3,D+3,O,V));let U=Math.max(0,B-2),H=Math.max(0,P-2);U>0&&H>0&&(e.viewport.lineStyle(2,6333946,1),e.viewport.drawRect($+1,D+1,U,H))})();let u=1===E.current.length?E.current[0]:null,h=u&&R.current.has(u)?u:null,m=I.current;if(m!==h){if(m){let e=g.current.get(m);e&&e.pause()}I.current=h}if(h){let e=g.current.get(h)??null;if(e){e.loop=!0;let t=Date.now(),r=Number(A.current.get(h)??0);e.paused&&t-r>250&&(A.current.set(h,t),e.play().catch(()=>{}))}}let x=T.current;if(x){let e=f.current.get(x),t=k.current.get(x);if(e&&t){let r=Number(e.texture?.orig?.width??0),n=Number(e.texture?.orig?.height??0);if(r>0&&n>0){let e=g.current.get(x)??null,i=e&&Number.isFinite(e.duration)?Number(e.duration):0,a=e&&Number.isFinite(e.currentTime)?Number(e.currentTime):0,l=i>0?j(a/i,0,1):0,o=Math.min(r,n),s=j(.065*o,10,22),c=j(.045*o,4,10),d=Math.max(10,r-2*s),u=-d/2,h=n/2-s-c,f=Math.min(c/2,6);t.visible=!0,t.clear(),t.roundRect(u,h,d,c,f),t.fill({color:0,alpha:.42}),t.roundRect(u,h,d,c,f),t.stroke({width:1,color:0xffffff,alpha:.1});let m=d*l;if(m>.75){let e=Math.min(f,m/2);t.roundRect(u,h,m,c,e),t.fill({color:6333946,alpha:.92})}}else t.visible=!1}}}),eq(n),eO()})(),()=>{}},[e.projectId]),(0,i.useEffect)(()=>{e.onFocusRequest?.(e=>{let t=u.current,r=d.current;if(!t||!r)return;let n=f.current.get(e);if(!n)return;let i=n.position,a=N(n,r.renderer.width,r.renderer.height,.88)??t.scale.x;ea([e]);let l=r.renderer.width/2-i.x*a,o=r.renderer.height/2-i.y*a;G(),Q({x:l,y:o,zoom:a},{durationMs:340,onComplete:()=>{let e=u.current;e&&(eP({world_x:e.position.x,world_y:e.position.y,zoom:e.scale.x}),eO())}})}),e.onViewportCenterRequest?.(()=>{let e=u.current,t=d.current;if(!e||!t)return{x:0,y:0};let r=new a.bRX(t.renderer.width/2,t.renderer.height/2),n=e.toLocal(r);return{x:n.x,y:n.y}})},[e.projectId]),(0,i.useEffect)(()=>{let e=u.current;e&&eq(e)},[ee,eV]);let eq=e=>{let t=new Set(ee.map(e=>e.id));for(let[e,r]of f.current.entries())t.has(e)||(r.destroy({children:!0}),f.current.delete(e),g.current.delete(e),R.current.delete(e),k.current.delete(e),L.current.delete(e),$.current.delete(e));for(let[e,r]of p.current.entries())t.has(e)||(r.destroy({children:!0}),p.current.delete(e),g.current.delete(e),R.current.delete(e),k.current.delete(e),L.current.delete(e),$.current.delete(e));for(let t of ee){if(f.current.has(t.id)){let e=f.current.get(t.id);e.position.set(t.x,t.y),e.scale.set(t.scale_x,t.scale_y),e.rotation=t.rotation,e.zIndex=t.z_index,z(e);let r=p.current.get(t.id);r&&(r.position.set(t.x,t.y),r.scale.set(t.scale_x,t.scale_y),r.rotation=t.rotation,r.zIndex=t.z_index-.25,L.current.has(t.id)||L.current.set(t.id,{current:0,target:0}));continue}if("image"===t.type&&t.asset_id){var r;let n=eV.get(t.asset_id);if(!n)continue;let i=new a.A1g;i.eventMode="none",i.position.set(t.x,t.y),i.scale.set(t.scale_x,t.scale_y),i.rotation=t.rotation,i.zIndex=t.z_index-.25,i.__objectId=t.id,p.current.set(t.id,i),L.current.set(t.id,{current:0,target:0}),e.addChild(i);let l=new a.kxk(a.gPd.EMPTY);if(l.eventMode="static",l.cursor="move",l.anchor.set(.5),l.position.set(t.x,t.y),l.scale.set(t.scale_x,t.scale_y),l.rotation=t.rotation,l.zIndex=t.z_index,l.__objectId=t.id,f.current.set(t.id,l),e.addChild(l),(r=n.mime_type)&&r.startsWith("video/")){R.current.add(t.id);let e=new a.A1g;e.eventMode="none",e.visible=!1,k.current.set(t.id,e),l.addChild(e)}else R.current.delete(t.id);let o=n.storage_url,s=o.startsWith("http")?o:new URL(o,window.location.href).toString(),c=x.current.get(s);if(c){l.texture=c,z(l);let e=_(l.texture);if(e){g.current.set(t.id,e);try{(1===E.current.length?E.current[0]:null)!==t.id&&(e.pause(),Number.isFinite(e.currentTime)&&0!==e.currentTime&&(e.currentTime=0),e.loop=!1)}catch{}}else g.current.delete(t.id);let r=l.texture?.orig?.width??0,n=l.texture?.orig?.height??0;if(r>0&&n>0){let e=Math.min(22,r/2,n/2);C(i,r,n,e,L.current.get(t.id)?.current??0)}eN(t.id,l.texture);continue}let d=w.current.get(s)??a.sP.load(s).then(e=>(x.current.set(s,e),e)).catch(e=>{throw console.error("pixi_texture_load_failed",s,e),e}).finally(()=>{w.current.delete(s)});w.current.set(s,d),d.then(e=>{let r=f.current.get(t.id);if(r){r.texture=e,z(r);let n=_(r.texture);if(n){g.current.set(t.id,n);try{(1===E.current.length?E.current[0]:null)!==t.id&&(n.pause(),Number.isFinite(n.currentTime)&&0!==n.currentTime&&(n.currentTime=0),n.loop=!1)}catch{}}else g.current.delete(t.id);let i=r.texture?.orig?.width??0,a=r.texture?.orig?.height??0;if(i>0&&a>0){let e=Math.min(22,i/2,a/2),r=p.current.get(t.id),n=L.current.get(t.id)?.current??0;r&&C(r,i,a,e,n)}eN(t.id,r.texture)}}).catch(()=>{})}}},eJ=async t=>{let r;t.preventDefault(),eo(null);let n=d.current,i=u.current;if(!n||!i)return;let l=Array.from(t.dataTransfer.files||[]);if(0===l.length)return;let o=n.canvas.getBoundingClientRect(),s=(t.clientX-o.left)*n.renderer.width/o.width,c=(t.clientY-o.top)*n.renderer.height/o.height,h=28*n.renderer.width/o.width,f=28*n.renderer.height/o.height,m=40*n.renderer.width/o.width,p=40*n.renderer.height/o.height,x=new FormData;for(let e of l)x.append("files",e,e.name);try{r=await fetch(`/api/projects/${e.projectId}/assets/upload`,{method:"POST",body:x})}catch(e){console.error("upload_failed(fetch)",e),eo("Upload failed (network). If you restarted dev server, refresh the page.");return}if(!r.ok){let e=await r.text().catch(()=>"");console.error("upload_failed(response)",r.status,e),eo(`Upload failed (${r.status}).`);return}let w=(await r.json()).assets||[];en(e=>{let t=[...w,...e],r=new Set;return t.filter(e=>!r.has(e.id)&&(r.add(e.id),!0))});let g=w.map(()=>globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`);g.length>0&&(P.current={objectId:g[0],rx:s,ry:c,fired:!1});let y=new Date().toISOString();et(t=>{let r=[...t],n=t.reduce((e,t)=>Math.max(e,t.z_index),0)+1;for(let t=0;t<w.length;t++){let l=w[t],o=t%12,d=Math.floor(t/12),u=i.toLocal(new a.bRX(s+o*h+d*m,c+o*f+d*p));r.push({id:g[t],project_id:e.projectId,type:"image",asset_id:l.id,x:u.x,y:u.y,scale_x:1,scale_y:1,rotation:0,width:l.width??null,height:l.height??null,z_index:n++,props_json:null,created_at:y,updated_at:y})}return e$(r),eD(r),r})};return(0,n.jsxs)("div",{onDragOver:e=>e.preventDefault(),onDrop:eJ,className:"relative h-full w-full",children:[(0,n.jsx)("div",{ref:c,className:"absolute inset-0 "+(eu?"opacity-0 pointer-events-none":"opacity-100")}),ef?(0,n.jsx)("div",{className:"pointer-events-none absolute inset-0 z-40 grid place-items-center",children:(0,n.jsx)("div",{className:"rounded-xl border border-white/10 bg-black/60 px-4 py-3 text-sm text-zinc-200 backdrop-blur",children:ep.syncing?"Syncingâ€¦":"Loadingâ€¦"})}):null,!ep.online||ep.syncing||ep.dirtyCanvas||ep.dirtyView?(0,n.jsx)("div",{className:"pointer-events-none absolute right-4 top-4 z-50",children:(0,n.jsx)("div",{className:"rounded-full border px-3 py-1 text-[11px] font-medium "+(ep.online?(ep.syncing,"border-amber-900/40 bg-amber-950/35 text-amber-200"):"border-red-900/50 bg-red-950/50 text-red-200"),children:ep.online?ep.syncing?"Syncingâ€¦":"Unsynced":"Offline"})}):null,el?(0,n.jsx)("div",{className:"pointer-events-none absolute left-1/2 top-10 -translate-x-1/2 rounded-lg border border-red-900/50 bg-red-950/60 px-3 py-2 text-xs text-red-200",children:el}):null,es&&eV.get(es)?(0,n.jsx)(o,{projectId:e.projectId,asset:eV.get(es),originRect:ej,onClose:()=>ec(null)}):null]})}var k=r(5012);function T(e){let[t,r]=(0,i.useState)(!1),[a,l]=(0,i.useState)(""),[o,s]=(0,i.useState)([]),c=(0,i.useRef)(null),d=(0,i.useMemo)(()=>{let t=new Map;for(let r of e.objects)"image"===r.type&&r.asset_id&&t.set(r.asset_id,r.id);return t},[e.objects]);(0,i.useEffect)(()=>{let e=e=>{(navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey)&&"k"===e.key.toLowerCase()&&(e.preventDefault(),r(e=>!e)),"Escape"===e.key&&r(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{if(!t)return;let r=window.setTimeout(async()=>{let t=await fetch(`/api/projects/${e.projectId}/assets/search?q=${encodeURIComponent(a)}&limit=50&mode=hybrid`);t.ok&&s((await t.json()).assets??[])},120);return()=>window.clearTimeout(r)},[t,a,e.projectId]),(0,i.useEffect)(()=>{if(!t)return;let e=window.requestAnimationFrame(()=>{let e=c.current;e&&(e.focus(),e.select())});return()=>window.cancelAnimationFrame(e)},[t]);let u=t?o:[];return(0,n.jsxs)(n.Fragment,{children:[t?(0,n.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}):null,(0,n.jsx)("div",{className:t?"fixed left-1/2 top-16 z-50 w-[720px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl":"hidden",children:(0,n.jsxs)(k.uB,{className:"flex flex-col overflow-hidden",children:[(0,n.jsx)("div",{className:"border-b border-zinc-900 p-3",children:(0,n.jsx)(k.uB.Input,{ref:c,autoFocus:!0,value:a,onValueChange:l,placeholder:"Search assetsâ€¦",className:"w-full bg-transparent text-sm outline-none placeholder:text-zinc-600"})}),(0,n.jsxs)(k.uB.List,{className:"max-h-[420px] overflow-auto p-2",children:[(0,n.jsx)(k.uB.Empty,{className:"p-3 text-sm text-zinc-500",children:"No results."}),u.map(t=>{let i=d.get(t.id),l="done"===t.ai_status?t.ai_caption:t.ai_status?t.ai_status:"";return(0,n.jsxs)(k.uB.Item,{value:`${t.original_name} ${t.ai_caption??""}`,onSelect:()=>{r(!1),i?e.onFocusObjectId(i):e.onPlaceAssetAtViewportCenter(t.id);let n=a.trim().split(/\s+/g).filter(Boolean)[0]?.toLowerCase();!n||e.onHighlightAsset&&fetch(`/api/projects/${e.projectId}/assets/${t.id}/segments?term=${encodeURIComponent(n)}`).then(e=>e.ok?e.json():null).then(r=>{r&&e.onHighlightAsset?.({assetId:t.id,term:n,svg:r.svg??null,bboxJson:r.bboxJson??null})}).catch(()=>{})},className:"flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 aria-selected:bg-zinc-900",children:[(0,n.jsx)("div",{className:"h-10 w-10 shrink-0 rounded bg-zinc-900 overflow-hidden",children:t.thumb_url?(0,n.jsx)("img",{src:t.thumb_url,alt:"",className:"h-full w-full object-contain"}):null}),(0,n.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,n.jsx)("div",{className:"truncate",children:t.original_name}),l?(0,n.jsx)("div",{className:"truncate text-xs text-zinc-500",children:l}):null]})]},t.id)})]}),(0,n.jsx)("div",{className:"border-t border-zinc-900 p-2 text-xs text-zinc-500"})]})})]})}var S=r(5702),I=r(7650);function A(e){return"undefined"==typeof document?null:(0,I.createPortal)(e.children,document.body)}function E(e){let t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}}function F(e){let t,r=(0,S.useRouter)(),[a,l]=(0,i.useState)(!1),[o,s]=(0,i.useState)([]),[c,d]=(0,i.useState)(null),[u,h]=(0,i.useState)(null),[f,m]=(0,i.useState)(null),[p,x]=(0,i.useState)(null),w=(0,i.useRef)(null),g=(0,i.useRef)(null),[y,v]=(0,i.useState)(null),b=(0,i.useMemo)(()=>o.find(t=>t.id===e.currentProjectId)??null,[o,e.currentProjectId]),j=async()=>{let e=await fetch("/api/projects");e.ok&&s((await e.json()).projects??[])};(0,i.useEffect)(()=>{j()},[]),(0,i.useLayoutEffect)(()=>{a&&w.current&&m(E(w.current))},[a]),(0,i.useLayoutEffect)(()=>{u&&g.current&&x(E(g.current))},[u]);let _=async()=>{if(!y||"new"!==y.type)return;let e=y.name.trim();if(e){d("new");try{let t=await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!t.ok)return;let n=await t.json();await j(),l(!1),h(null),v(null),r.push(`/projects/${n.project.id}`)}finally{d(null)}}},M=async e=>{if(!y||"rename"!==y.type||y.project.id!==e.id)return;let t=y.name.trim();if(t){d(e.id);try{if(!(await fetch(`/api/projects/${e.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})})).ok)return;await j(),h(null),v(null)}finally{d(null)}}},N=async t=>{if(y&&"delete"===y.type&&y.project.id===t.id){d(t.id);try{if(!(await fetch(`/api/projects/${t.id}`,{method:"DELETE"})).ok)return;await j(),l(!1),h(null),v(null),t.id===e.currentProjectId&&r.push("/")}finally{d(null)}}};return(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsxs)("button",{ref:w,onClick:()=>{l(e=>!e),h(null)},className:"text"===e.variant?"inline-flex items-center gap-2 px-2 py-1 text-sm font-medium text-zinc-200 hover:text-zinc-50":"inline-flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{className:"max-w-[220px] truncate",children:b?.name??"Select project"}),(0,n.jsx)("span",{className:"text-zinc-500",children:"â–¾"})]}),(0,n.jsxs)(A,{children:[a&&f?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9998]",onMouseDown:()=>{l(!1),h(null)}}),(0,n.jsxs)("div",{className:"fixed z-[9999] w-[340px] rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl",style:{left:Math.max(8,Math.min(window.innerWidth-340-8,"center"===(t=e.align??"right")?f.left+f.width/2-170:"left"===t?f.left:f.left+f.width-340)),top:f.top+f.height+8},children:[(0,n.jsxs)("div",{className:"flex items-center justify-between border-b border-zinc-900 px-3 py-2",children:[(0,n.jsx)("div",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Projects"}),(0,n.jsx)("button",{onClick:()=>v({type:"new",name:"New project"}),disabled:"new"===c,className:"rounded-md bg-zinc-50 px-2 py-1 text-xs font-medium text-zinc-950 disabled:opacity-60",children:"New"})]}),(0,n.jsx)("div",{className:"max-h-[360px] overflow-auto",children:o.map(t=>{let i=t.id===e.currentProjectId,a=c===t.id;return(0,n.jsxs)("div",{className:`flex items-center gap-2 px-3 py-2 text-sm ${i?"bg-zinc-900/60":"hover:bg-zinc-900"}`,children:[(0,n.jsxs)("button",{disabled:a,onClick:()=>{l(!1),h(null),r.push(`/projects/${t.id}`)},className:"min-w-0 flex-1 text-left flex items-center gap-3",children:[(0,n.jsx)("div",{className:"h-12 w-12 shrink-0 overflow-hidden rounded-lg border border-white/10 bg-zinc-900",children:(0,n.jsx)("img",{src:`/files/projects/${t.id}/preview`,alt:"",className:"h-full w-full object-cover",onError:e=>{e.currentTarget.style.display="none"}})}),(0,n.jsx)("div",{className:"min-w-0 flex-1",children:(0,n.jsx)("div",{className:"truncate text-zinc-200",children:t.name})})]}),(0,n.jsx)("button",{ref:u?.id===t.id?g:null,disabled:a,onClick:e=>{e.stopPropagation(),h(e=>e?.id===t.id?null:t)},className:"rounded-md px-2 py-1 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200",title:"Project actions",children:"â‹¯"})]},t.id)})})]})]}):null,u&&p?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9999]",onMouseDown:()=>h(null)}),(0,n.jsxs)("div",{className:"fixed z-[10000] w-40 rounded-lg border border-zinc-800 bg-zinc-950 shadow-xl overflow-hidden",style:{left:Math.min(window.innerWidth-168,p.left+p.width-160),top:p.top+p.height+6},children:[(0,n.jsx)("button",{onClick:()=>v({type:"rename",project:u,name:u.name}),className:"block w-full px-3 py-2 text-left text-sm text-zinc-200 hover:bg-zinc-900",children:"Renameâ€¦"}),(0,n.jsx)("button",{onClick:()=>v({type:"delete",project:u}),className:"block w-full px-3 py-2 text-left text-sm text-red-300 hover:bg-zinc-900",children:"Deleteâ€¦"})]})]}):null,y?(0,n.jsxs)("div",{className:"fixed inset-0 z-[10001]",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/50",onMouseDown:()=>v(null)}),(0,n.jsx)("div",{className:"absolute left-1/2 top-28 w-[420px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 p-4 shadow-2xl",children:"delete"===y.type?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"Delete project?"}),(0,n.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:y.project.name}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>v(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>N(y.project),disabled:c===y.project.id,className:"rounded-md bg-red-500 px-3 py-2 text-sm font-medium text-white disabled:opacity-60",children:"Delete"})]})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"new"===y.type?"New project":"Rename project"}),(0,n.jsx)("input",{autoFocus:!0,value:y.name,onChange:e=>{let t=e.target.value;v(e=>e&&("new"===e.type||"rename"===e.type)?{...e,name:t}:e)},className:"mt-3 w-full rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 outline-none focus:border-zinc-600",placeholder:"Project name"}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>v(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>{"new"===y.type&&_(),"rename"===y.type&&M(y.project)},disabled:"new"===c||"rename"===y.type&&c===y.project.id,className:"rounded-md bg-zinc-50 px-3 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:"Save"})]})]})})]}):null]})]})}function L(e){let{project:t}=e,[r,a]=(0,i.useState)(e.initialObjects),[l,o]=(0,i.useState)(null),[s,c]=(0,i.useState)(null),[d,u]=(0,i.useState)(null);return(0,n.jsxs)("div",{className:"h-screen w-screen bg-zinc-950 text-zinc-50 overflow-hidden",children:[(0,n.jsx)(R,{projectId:t.id,initialAssets:e.initialAssets,initialObjects:r,initialView:e.initialView,highlightOverlay:l,onObjectsChange:a,onFocusRequest:e=>c(()=>e),onViewportCenterRequest:e=>u(()=>e)}),(0,n.jsx)("div",{className:"pointer-events-none absolute inset-x-0 top-0 z-40 h-14 bg-gradient-to-b from-black/50 to-transparent"}),(0,n.jsx)("div",{className:"absolute left-3 top-3 z-50",children:(0,n.jsx)(F,{currentProjectId:t.id,variant:"text",align:"left"})}),(0,n.jsx)(T,{projectId:t.id,objects:r,onFocusObjectId:e=>s?.(e),onPlaceAssetAtViewportCenter:async e=>{let n=d?.()??{x:0,y:0},i=[...r,{id:globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`,project_id:t.id,type:"image",asset_id:e,x:n.x,y:n.y,scale_x:1,scale_y:1,rotation:0,width:null,height:null,z_index:r.reduce((e,t)=>Math.max(e,t.z_index),0)+1,props_json:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}];a(i),await fetch(`/api/projects/${t.id}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:i})})},onHighlightAsset:e=>o(e)})]})}},945:(e,t,r)=>{Promise.resolve().then(r.bind(r,22))}},e=>{e.O(0,[679,441,794,358],()=>e(e.s=945)),_N_E=e.O()}]);