(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{22:(e,t,r)=>{"use strict";r.d(t,{ProjectWorkspace:()=>F});var n=r(5155),i=r(2115),a=r(6878);function l(e){if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}}function s(e){let{asset:t,projectId:r,onClose:a}=e,s=!!t.mime_type&&t.mime_type.startsWith("video/"),[o,c]=(0,i.useState)(!1),[d,u]=(0,i.useState)(!!e.originRect),[h,f]=(0,i.useState)(null),[m,p]=(0,i.useState)(null),[x,w]=(0,i.useState)(null),[g,y]=(0,i.useState)(null),[v,b]=(0,i.useState)("translate(0px,0px) scale(1,1)"),j=(0,i.useMemo)(()=>(function(e){if(!e)return[];try{let t=JSON.parse(e);if(!Array.isArray(t))return[];return t.map(e=>String(e)).filter(Boolean)}catch{return[]}})(t.ai_tags_json),[t.ai_tags_json]),_=(0,i.useRef)(null),[M,N]=(0,i.useState)(null),z=(0,i.useMemo)(()=>m?h?.find(e=>e.tag===m)??null:null,[h,m]);(0,i.useEffect)(()=>{let e=window.setTimeout(()=>c(!0),0);return()=>window.clearTimeout(e)},[]),(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&a()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[a]),(0,i.useEffect)(()=>{let e=!1;return f(null),p(null),fetch(`/api/projects/${r}/assets/${t.id}/segments`).then(e=>e.ok?e.json():null).then(t=>{if(e)return;let r=t?.segments??null;f(Array.isArray(r)?r:[])}).catch(()=>{e||f([])}),()=>{e=!0}},[t.id,r]);let C=(0,i.useCallback)(()=>{let e=_.current;if(!e)return;let r=e.clientWidth,n=e.clientHeight,i=e.naturalWidth||t.width||0,a=e.naturalHeight||t.height||0;if(!(r>2&&n>2&&i>2&&a>2))return void N(null);let l=Math.min(r/i,n/a),s=i*l,o=a*l;N({offsetX:(r-s)/2,offsetY:(n-o)/2,drawW:s,drawH:o,scale:l})},[t.height,t.width]);return(0,i.useEffect)(()=>{C();let e=()=>C();return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[C]),(0,i.useEffect)(()=>{let e=_.current;if(!e)return;let t=new ResizeObserver(()=>C());return t.observe(e),()=>t.disconnect()},[C]),(0,i.useEffect)(()=>{let t=e.originRect??null;if(!t){u(!1),y(null),w(null);return}let r=window.setTimeout(()=>{let e=document.querySelector("[data-asset-lightbox-target='true']");if(!e)return void u(!1);let r=e.getBoundingClientRect();if(!(r.width>2&&r.height>2))return void u(!1);let n={left:r.left,top:r.top,width:r.width,height:r.height};w(n),y({position:"fixed",left:n.left,top:n.top,width:n.width,height:n.height,zIndex:1e4,pointerEvents:"none",transition:"transform 240ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 140ms ease-out",transformOrigin:"center center",opacity:1});let i=t.left+t.width/2,a=t.top+t.height/2,l=n.left+n.width/2,s=n.top+n.height/2,o=t.width/n.width,c=t.height/n.height;b(`translate(${i-l}px, ${a-s}px) scale(${o}, ${c})`),requestAnimationFrame(()=>{requestAnimationFrame(()=>b("translate(0px, 0px) scale(1, 1)"))}),window.setTimeout(()=>{u(!1),y(null)},260)},0);return()=>window.clearTimeout(r)},[e.originRect,t.id]),(0,n.jsxs)("div",{className:"fixed inset-0 z-[9999] bg-black transition-opacity duration-200 "+(o?"opacity-100":"opacity-0"),onClick:()=>a(),"aria-modal":"true",role:"dialog",children:[g?(0,n.jsx)("div",{style:{...g,transform:v},children:s?(0,n.jsx)("video",{src:t.storage_url,className:"h-full w-full object-contain",muted:!0,playsInline:!0}):(0,n.jsx)("img",{src:t.storage_url,alt:"",className:"h-full w-full object-contain",draggable:!1})}):null,(0,n.jsxs)("div",{className:"flex h-full w-full flex-col md:flex-row md:gap-0 transition-transform duration-200 ease-out "+(o?"scale-100":"scale-[0.985]"),onClick:e=>e.stopPropagation(),children:[(0,n.jsx)("div",{className:"flex min-h-0 flex-1 items-center justify-center p-4 md:p-8",children:(0,n.jsxs)("div",{className:"relative h-full w-full max-w-[min(1100px,100%)]",children:[s?(0,n.jsx)("video",{"data-asset-lightbox-target":"true",src:t.storage_url,controls:!0,playsInline:!0,className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100")}):(0,n.jsx)("img",{"data-asset-lightbox-target":"true",ref:_,src:t.storage_url,alt:t.original_name||"asset",className:"h-full w-full object-contain "+(d?"opacity-0":"opacity-100"),draggable:!1,onLoad:()=>C()}),!d&&z&&M?(0,n.jsxs)("div",{className:"pointer-events-none absolute inset-0",children:[z.svg&&z.svg.trim().startsWith("<svg")?(0,n.jsx)("img",{alt:"",draggable:!1,src:`data:image/svg+xml;charset=utf-8,${encodeURIComponent(z.svg)}`,style:{position:"absolute",left:M.offsetX,top:M.offsetY,width:M.drawW,height:M.drawH,opacity:.22,mixBlendMode:"screen",filter:"drop-shadow(0px 0px 10px rgba(124, 58, 237, 0.65))"}}):null,l(z.bboxJson).map((e,t)=>{let r=e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5,i=r?e.x*M.drawW:e.x*M.scale,a=r?e.y*M.drawH:e.y*M.scale,l=r?e.w*M.drawW:e.w*M.scale,s=r?e.h*M.drawH:e.h*M.scale;return(0,n.jsx)("div",{style:{position:"absolute",left:M.offsetX+i,top:M.offsetY+a,width:l,height:s},className:"rounded-sm border-2 border-violet-400/90 bg-violet-500/10 shadow-[0_0_18px_rgba(124,58,237,0.55)]"},`${z.tag}-${t}`)})]}):null]})}),(0,n.jsxs)("aside",{className:"w-full shrink-0 border-t border-white/10 bg-zinc-950/60 backdrop-blur md:w-[420px] md:border-l md:border-t-0",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between gap-3 border-b border-white/10 p-4",children:[(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("div",{className:"truncate text-sm font-medium text-zinc-100",children:t.original_name}),(0,n.jsxs)("div",{className:"truncate text-xs text-zinc-400",children:[t.width&&t.height?`${t.width}\xd7${t.height}`:"",t.mime_type?t.width&&t.height?` \xb7 ${t.mime_type}`:t.mime_type:"",Number.isFinite(t.byte_size)?` \xb7 ${function(e){if(!Number.isFinite(e)||e<=0)return"0 B";let t=["B","KB","MB","GB","TB"],r=Math.min(t.length-1,Math.floor(Math.log(e)/Math.log(1024))),n=e/Math.pow(1024,r);return`${n.toFixed(n>=10||0===r?0:1)} ${t[r]}`}(t.byte_size)}`:""]})]}),(0,n.jsx)("button",{onClick:()=>a(),className:"rounded-md border border-white/10 bg-black/30 px-2 py-1 text-xs text-zinc-200 hover:bg-black/50",children:"Close"})]}),(0,n.jsx)("div",{className:"max-h-[45vh] overflow-auto p-4 md:max-h-none md:h-[calc(100%-57px)]",children:(0,n.jsxs)("div",{className:"space-y-5",children:[(0,n.jsx)("section",{children:(0,n.jsxs)("div",{className:"mt-2 space-y-2 text-sm text-zinc-100",children:[t.ai_caption?(0,n.jsx)("div",{className:"rounded-lg border border-white/10 bg-black/20 p-3 text-sm text-zinc-100",children:t.ai_caption}):null,j.length?(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:j.slice(0,64).map(e=>(0,n.jsx)("div",{className:"rounded-full border border-white/10 bg-black/20 px-2 py-1 text-xs text-zinc-200",children:e},e))}):null]})}),(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"Segments"}),(0,n.jsx)("div",{className:"mt-2",children:null===h?(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"Loading…"}):h.length?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"mb-2 flex items-center justify-between gap-2",children:[(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"Click a tag to highlight it on the image."}),m?(0,n.jsx)("button",{onClick:()=>p(null),className:"rounded-md border border-white/10 bg-black/30 px-2 py-1 text-[11px] text-zinc-200 hover:bg-black/50",children:"Clear"}):null]}),(0,n.jsx)("div",{className:"flex flex-wrap gap-2",children:h.slice(0,80).map(e=>{let t=e.tag===m;return(0,n.jsx)("button",{type:"button",onClick:()=>p(t=>t===e.tag?null:e.tag),className:"rounded-full border px-2 py-1 text-xs "+(t?"border-violet-400/60 bg-violet-500/15 text-zinc-100":"border-white/10 bg-black/20 text-zinc-200 hover:bg-black/30"),title:e.updatedAt,children:e.tag},e.tag)})}),!m||z?.svg||l(z?.bboxJson??null).length?null:(0,n.jsxs)("div",{className:"mt-2 text-xs text-zinc-500",children:["No overlay data cached for ",(0,n.jsx)("span",{className:"text-zinc-300",children:m}),"."]})]}):(0,n.jsx)("div",{className:"text-xs text-zinc-500",children:"No cached segments."})})]}),(0,n.jsxs)("section",{children:[(0,n.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"File"}),(0,n.jsxs)("div",{className:"mt-2 space-y-2 text-xs text-zinc-300",children:[(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"Created:"})," ",t.created_at]}),t.ai_updated_at?(0,n.jsxs)("div",{className:"break-all",children:[(0,n.jsx)("span",{className:"text-zinc-500",children:"AI Updated:"})," ",t.ai_updated_at]}):null]})]})]})})]})]})]})}let o="projectDrafts",c=new Map,d=new Set,u=null;function h(){return u||(u=new Promise((e,t)=>{let r=indexedDB.open("moondream",1);r.onupgradeneeded=()=>{let e=r.result;e.objectStoreNames.contains(o)||e.createObjectStore(o,{keyPath:"projectId"})},r.onsuccess=()=>e(r.result),r.onerror=()=>{let e=r.error??Error("indexedDB.open failed");u=null,t(e)}}))}function f(e){return new Promise((t,r)=>{e.oncomplete=()=>t(),e.onerror=()=>r(e.error??Error("IDB transaction failed")),e.onabort=()=>r(e.error??Error("IDB transaction aborted"))})}async function m(e){var t,r;let n,i,a=c.get(e)??null;if(d.has(e))return a;let l=(await h()).transaction(o,"readonly"),s=l.objectStore(o).get(e),u=await new Promise((e,t)=>{s.onsuccess=()=>e(s.result??null),s.onerror=()=>t(s.error??Error("IDB get failed"))});if(await f(l),d.add(e),!u)return a;if(!a)return c.set(e,u),u;let m=(t=u,n=(r=a).canvas??t.canvas,i=r.view??t.view,{...t,...r,projectId:r.projectId,updatedAt:Math.max(t.updatedAt,r.updatedAt),canvas:n,view:i,dirtyCanvas:null===r.canvas?t.dirtyCanvas:r.dirtyCanvas,dirtyView:null===r.view?t.dirtyView:r.dirtyView});return c.set(e,m),m}async function p(e){c.set(e.projectId,e);let t=(await h()).transaction(o,"readwrite");t.objectStore(o).put(e),await f(t)}let x=new Map,w=globalThis.requestIdleCallback??((e,t)=>globalThis.setTimeout(()=>e({didTimeout:!0,timeRemaining:()=>0}),Math.max(0,t?.timeout??200)));async function g(e){let t=x.get(e);if(t&&!t.inFlight){t.inFlight=!0;try{let r=t.next;if(await p(r),t.inFlight=!1,t.next===r){t.resolve(r),x.delete(e);return}t.scheduled||(t.scheduled=!0,w(()=>{let t=x.get(e);t&&(t.scheduled=!1,g(e))},{timeout:t.timeoutMs}))}catch(r){t.inFlight=!1,t.reject(r),x.delete(e)}}}async function y(e,t){return await function(e,t,r){let n={...c.get(e)??{projectId:e,updatedAt:0,canvas:null,view:null,dirtyCanvas:!1,dirtyView:!1},...t,projectId:e,updatedAt:t.updatedAt??Date.now()};c.set(e,n);let i=x.get(e);if(i)i.next=n,i.timeoutMs=r?.timeoutMs??i.timeoutMs;else{let t,a,l=new Promise((e,r)=>{t=e,a=r});i={next:n,timeoutMs:r?.timeoutMs??300,scheduled:!1,inFlight:!1,promise:l,resolve:t,reject:a},x.set(e,i)}return i.scheduled||i.inFlight||(i.scheduled=!0,w(()=>{(i=x.get(e))&&(i.scheduled=!1),g(e)},{timeout:i.timeoutMs})),i.promise}(e,t,{timeoutMs:300})}let v="#0a0a0a",b={bgHex:592139,bgAlpha:.88,strokeHex:0xffffff,strokeAlpha:.1,shadeAlpha:.28};function j(e,t,r){return Math.max(t,Math.min(r,e))}function _(e){for(let t of[e?.source?.resource,e?.source?.resource?.source,e?.source?.resource?.domElement,e?.baseTexture?.resource,e?.baseTexture?.resource?.source,e?.baseTexture?.resource?.domElement,e?.baseTexture?.source?.resource,e?.baseTexture?.source?.resource?.source])if(t){if("undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement)return t;if("undefined"!=typeof HTMLVideoElement&&t?.source instanceof HTMLVideoElement)return t.source;if("undefined"!=typeof HTMLVideoElement&&t?.domElement instanceof HTMLVideoElement)return t.domElement;if("undefined"!=typeof HTMLVideoElement&&t?.element instanceof HTMLVideoElement)return t.element}return null}function M(e,t){e.clear(),e.roundRect(0,0,220,160,10),e.fill({color:t.bgHex,alpha:t.bgAlpha}),e.stroke({color:t.strokeHex,width:1,alpha:t.strokeAlpha})}function N(e){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)return;let n=Math.min(22,t/2,r/2),i=e.__roundMask;i||((i=new a.A1g).eventMode="none",i.visible=!0,e.__roundMask=i,e.addChild(i),e.mask=i),i.clear(),i.roundRect(-t/2,-r/2,t,r,n),i.fill(0xffffff)}function z(e,t,r,n,i){e.clear();let a=j(i,0,1),l=.1+.06*a,s=6+4*a,o=18+10*a;for(let i=0;i<8;i++){let a=i/7,c=o*(.2+1.05*a),d=(1-a)*(1-a)*l*.45,u=Math.min(n+c,(t+2*c)/2,(r+2*c)/2);e.roundRect(-t/2-c+s,-r/2-c+s,t+2*c,r+2*c,u),e.fill({color:0,alpha:d})}}function C(e){let t=e.projectId,r=e.initialObjects,l=e.initialView??null,o=e.onObjectsChange,c=(0,i.useRef)(null),d=(0,i.useRef)(null),u=(0,i.useRef)(null),h=(0,i.useRef)(null),f=(0,i.useRef)(new Map),p=(0,i.useRef)(new Map),x=(0,i.useRef)(new Map),w=(0,i.useRef)(new Map),g=(0,i.useRef)(new Map),C=(0,i.useRef)(new Set),k=(0,i.useRef)(new Map),S=(0,i.useRef)(null),R=(0,i.useRef)(new Map),T=(0,i.useRef)([]),I=(0,i.useRef)(new Map),A=(0,i.useRef)(new Map),E=(0,i.useRef)(new Set),F=(0,i.useRef)(null),L=(0,i.useRef)(new a.bRX(.5,.5)),D=(0,i.useRef)(null),$=(0,i.useRef)(null),B=(0,i.useRef)(null),P=(0,i.useRef)(null),O=(0,i.useRef)({}),V=(0,i.useRef)(null),U=(0,i.useRef)(null),X=(0,i.useRef)(null),[H,W]=(0,i.useState)(r),[q,J]=(0,i.useState)(e.initialAssets),[Y,K]=(0,i.useState)([]),[G,Q]=(0,i.useState)(null),[Z,ee]=(0,i.useState)(null),et=(0,i.useRef)(null),[er,en]=(0,i.useState)(()=>({online:"undefined"==typeof navigator||navigator.onLine,dirtyCanvas:!1,dirtyView:!1,syncing:!1})),ei=(0,i.useRef)({canvas:!1,view:!1}),ea=(0,i.useRef)(null),el=(0,i.useRef)(null),es=(0,i.useRef)(null),[eo,ec]=(0,i.useState)(null),ed=(e,t,r)=>{let n=d.current,i=h.current,a=F.current;if(!n||!i||!a)return;let l=Math.max(1,n.renderer.width),s=Math.max(1,n.renderer.height),o=j(e/l,0,1),c=j(t/s,0,1);L.current.set(o,c),a.active=!0,a.timeSec=0,a.uniforms.uniforms.uTime=0,a.uniforms.uniforms.uCenter.set(o,c),a.uniforms.uniforms.uAspect=l/s,a.uniforms.uniforms.uShapeAspect=j(Number(r?.shapeAspect??1)||1,.05,20),a.uniforms.uniforms.uShapeRotation=Number(r?.shapeRotation??0)||0,i.filters&&0!==i.filters.length?i.filters.includes(a.filter)||(i.filters=[a.filter,...i.filters]):i.filters=[a.filter]},eu=(e,t)=>{let r=D.current;if(!r||r.fired||r.objectId!==e)return;let n=Number(t?.orig?.width??0),i=Number(t?.orig?.height??0);n>0&&i>0&&(r.fired=!0,ed(r.rx,r.ry,{shapeAspect:n/i,shapeRotation:0}))},eh=(0,i.useRef)(r);(0,i.useEffect)(()=>{eh.current=H},[H]);let ef=(0,i.useRef)(b),em=(0,i.useRef)(b.shadeAlpha);(0,i.useEffect)(()=>{T.current=Y},[Y]),(0,i.useEffect)(()=>J(e.initialAssets),[e.initialAssets]),(0,i.useEffect)(()=>{W(r),et.current=null,ei.current={canvas:!1,view:!1},en(e=>({...e,dirtyCanvas:!1,dirtyView:!1,syncing:!1}))},[t]);let ep=e=>{ei.current.canvas!==e&&(ei.current.canvas=e,en(t=>({...t,dirtyCanvas:e})))},ex=e=>{ei.current.view!==e&&(ei.current.view=e,en(t=>({...t,dirtyView:e})))};(0,i.useEffect)(()=>{let e=()=>en(e=>({...e,online:"undefined"==typeof navigator||navigator.onLine}));return e(),window.addEventListener("online",e),window.addEventListener("offline",e),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",e)}},[]),(0,i.useEffect)(()=>{let e=!1;return(async()=>{try{let n=await m(t);if(e)return;if(!n){ep(!1),ex(!1),y(t,{canvas:r,view:l,dirtyCanvas:!1,dirtyView:!1}).catch(()=>{});return}ep(!!n.dirtyCanvas),ex(!!n.dirtyView);let i=Math.max(0,...r.map(e=>Date.parse(e.updated_at||e.created_at||"")).filter(e=>Number.isFinite(e)));if(n.canvas&&(n.dirtyCanvas||n.updatedAt>i)&&(W(n.canvas),o?.(n.canvas)),n.view){et.current=n.view;let e=u.current;if(e){e.position.set(n.view.world_x,n.view.world_y);let t=Number.isFinite(n.view.zoom)?n.view.zoom:1;e.scale.set(j(t,.01,1))}}}catch{}})(),()=>{e=!0}},[t,r,o]);let ew=async()=>{if(ea.current)return ea.current;if(!er.online)return;let e=(async()=>{en(e=>({...e,syncing:!0}));try{let e=await m(t);if(!e)return;let r=!!e.dirtyCanvas,n=!!e.dirtyView;if(r&&e.canvas)try{let n=await fetch(`/api/projects/${t}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:e.canvas})});if(!n.ok)throw Error(`canvas_sync_failed:${n.status}`);r=!1,await y(t,{canvas:e.canvas,dirtyCanvas:!1}).catch(()=>{})}catch{}if(n&&e.view)try{let r=await fetch(`/api/projects/${t}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.view)});if(!r.ok)throw Error(`view_sync_failed:${r.status}`);n=!1,await y(t,{view:e.view,dirtyView:!1}).catch(()=>{})}catch{}ep(r),ex(n)}finally{en(e=>({...e,syncing:!1})),ea.current=null}})();return ea.current=e,e};(0,i.useEffect)(()=>{if(!er.online||!er.dirtyCanvas&&!er.dirtyView)return;ew();let e=window.setInterval(()=>void ew(),3e3);return()=>window.clearInterval(e)},[t,er.online,er.dirtyCanvas,er.dirtyView]);let eg=(0,i.useRef)(null),ey=(0,i.useRef)(null),ev=(0,i.useRef)(null),eb=(0,i.useRef)(null),ej=(0,i.useRef)(null),e_=e=>{!o||(ej.current=e,eb.current||(eb.current=window.setTimeout(()=>{eb.current=null;let e=ej.current;ej.current=null,e&&o?.(e)},0)))},eM=r=>{el.current&&window.clearTimeout(el.current),el.current=window.setTimeout(()=>{y(t,{canvas:r,dirtyCanvas:!0}).catch(()=>{})},40),ep(!0),eg.current&&window.clearTimeout(eg.current),eg.current=window.setTimeout(async()=>{try{let n=await fetch(`/api/projects/${e.projectId}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:r})});if(!n.ok)throw Error(`canvas_save_failed:${n.status}`);y(t,{canvas:r,dirtyCanvas:!1}).catch(()=>{}),ep(!1)}catch{ep(!0)}},250),eC()},eN=async r=>{el.current&&(window.clearTimeout(el.current),el.current=null),y(t,{canvas:r,dirtyCanvas:!0}).catch(()=>{}),ep(!0),eg.current&&(window.clearTimeout(eg.current),eg.current=null);try{let n=await fetch(`/api/projects/${e.projectId}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:r})});if(!n.ok)throw Error(`canvas_save_failed:${n.status}`);y(t,{canvas:r,dirtyCanvas:!1}).catch(()=>{}),ep(!1)}catch{ep(!0)}},ez=r=>{es.current&&window.clearTimeout(es.current),es.current=window.setTimeout(()=>{y(t,{view:r,dirtyView:!0}).catch(()=>{})},60),ex(!0),ey.current&&window.clearTimeout(ey.current),ey.current=window.setTimeout(async()=>{try{let n=await fetch(`/api/projects/${e.projectId}/view`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!n.ok)throw Error(`view_save_failed:${n.status}`);y(t,{view:r,dirtyView:!1}).catch(()=>{}),ex(!1)}catch{ex(!0)}},250)},eC=()=>{ev.current&&window.clearTimeout(ev.current),ev.current=window.setTimeout(async()=>{let t=d.current,r=$.current;if(!t||!r)return;let n=r.content,i=r.spriteById,l=1/0,s=1/0,o=-1/0,c=-1/0;for(let e of f.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;l=Math.min(l,e.position.x-n),o=Math.max(o,e.position.x+n),s=Math.min(s,e.position.y-i),c=Math.max(c,e.position.y+i)}if(!Number.isFinite(l)||!Number.isFinite(s)||!Number.isFinite(o)||!Number.isFinite(c))return;let u=Math.max(Math.max(1,o-l),Math.max(1,c-s)),h=Math.max(24,.08*u),m=(l+o)/2,p=(s+c)/2,x=new Set;for(let e of f.current.values()){let t=e.__objectId;if(!t)continue;let r=e.texture,l=r?.orig?.width??0,s=r?.orig?.height??0;if(l<=0||s<=0)continue;x.add(t);let o=i.get(t);o?o.texture!==r&&(o.texture=r):((o=new a.kxk(r)).anchor.set(.5),o.eventMode="none",n.addChild(o),i.set(t,o)),o.position.copyFrom(e.position),o.scale.copyFrom(e.scale),o.rotation=e.rotation,o.alpha=1}for(let[e,t]of i.entries())x.has(e)||(t.destroy({children:!0,texture:!1}),i.delete(e));let w=256/(u+2*h);n.scale.set(w),n.position.set(128-m*w,128-p*w),t.renderer.render({container:r.root,target:r.rt,clear:!0,clearColor:657930});let g=t.renderer.extract.canvas({target:r.rt}),y=null;if(g?.convertToBlob?(y=await g.convertToBlob({type:"image/webp",quality:.75}).catch(()=>null))||(y=await g.convertToBlob({type:"image/png"}).catch(()=>null)):g?.toBlob&&(y=await new Promise(e=>g.toBlob(e,"image/webp",.75))??await new Promise(e=>g.toBlob(e,"image/png"))),!y)return;let v=await y.arrayBuffer();await fetch(`/api/projects/${e.projectId}/preview`,{method:"PUT",headers:{"Content-Type":y.type||"image/webp"},body:v}).catch(()=>{})},1200)},ek=(0,i.useMemo)(()=>{let e=new Map;for(let t of q)e.set(t.id,t);return e},[q]);(0,i.useMemo)(()=>new Set(Y),[Y]),1===Y.length&&Y[0];let eS=e=>{let t=S.current;if(t!==e){if(S.current=e,t){let e=k.current.get(t);e&&(e.visible=!1);let r=g.current.get(t);r&&r.pause()}if(e){R.current.set(e,0);let t=k.current.get(e);t&&(t.visible=!0)}}},eR=()=>{for(let[e,t]of I.current.entries()){try{t.destroy({children:!0})}catch{}I.current.delete(e)}},eT=(e,t)=>{let r=j(t,0,1);for(let t of e){let e=A.current.get(t)??{current:0,target:0};e.target=r,A.current.set(t,e),E.current.add(t)}},eI=(t,r)=>{let n=f.current.get(t);if(!n)return;let i=e.highlightOverlay;if(!i||i.assetId!==r)return;let l=n.texture?.orig?.width??0,s=n.texture?.orig?.height??0;if((l<=0||s<=0)&&ek.get(r)){let e=ek.get(r);l=e.width??0,s=e.height??0}if(l<=0||s<=0)return;let o=new a.mcf;if(o.eventMode="none",i.svg&&i.svg.trim().startsWith("<svg")){let e=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(i.svg)}`,t=a.gPd.from(e),r=new a.kxk(t);r.anchor.set(.5),r.width=l,r.height=s,r.alpha=.22,r.tint=6333946,r.blendMode="screen",o.addChild(r)}let c=(e=>{if(!e)return[];try{let t=JSON.parse(e),r=t?.boxes;if(!Array.isArray(r))return[];return r.map(e=>({x:Number(e?.x??0),y:Number(e?.y??0),w:Number(e?.w??0),h:Number(e?.h??0)})).filter(e=>Number.isFinite(e.x)&&Number.isFinite(e.y)&&e.w>0&&e.h>0)}catch{return[]}})(i.bboxJson);if(c.length){let e=c.every(e=>e.x>=0&&e.y>=0&&e.x<=1.5&&e.y<=1.5&&e.w>0&&e.h>0&&e.w<=1.5&&e.h<=1.5),t=new a.A1g;for(let r of(t.eventMode="none",c)){let n=e?r.x*l:r.x,i=e?r.y*s:r.y,a=e?r.w*l:r.w,o=e?r.h*s:r.h,c=-l/2+n,d=-s/2+i;t.rect(c,d,a,o),t.fill({color:6333946,alpha:.1}),t.stroke({color:6333946,alpha:.85,width:3})}o.addChild(t)}n.addChild(o),I.current.set(t,o)};(0,i.useEffect)(()=>{eR();let t=e.highlightOverlay;if(t){for(let e of H)"image"===e.type&&e.asset_id&&e.asset_id===t.assetId&&eI(e.id,e.asset_id);return()=>{eR()}}},[e.highlightOverlay,H,ek]),(0,i.useEffect)(()=>{let e=e=>{let t=document.activeElement,r=t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable);if(!r&&("r"===e.key||"R"===e.key)){let t=d.current,r=u.current;if(!t)return;e.preventDefault();let n=1===T.current.length?T.current[0]:null;if(n&&r){let e=f.current.get(n);if(e){let t=e.getGlobalPosition(new a.bRX),r=e.texture?.orig?.width??0,n=e.texture?.orig?.height??0,i=Math.abs(e.scale.x)||1,l=Math.abs(e.scale.y)||1,s=r>0&&n>0?r*i/Math.max(1e-6,n*l):1;ed(t.x,t.y,{shapeAspect:s,shapeRotation:e.rotation});return}}ed(t.renderer.width/2,t.renderer.height/2);return}if(!r&&("0"===e.key||"Digit0"===e.code||"Numpad0"===e.code)){let t=d.current,r=u.current;if(!t||!r)return;e.preventDefault();let n=new a.bRX(t.renderer.width/2,t.renderer.height/2),i=r.toLocal(n),l=j(.1,.01,1);if(r.scale.x!==l||r.scale.y!==l){r.scale.set(l);let e=r.toLocal(n);r.position.x+=(e.x-i.x)*r.scale.x,r.position.y+=(e.y-i.y)*r.scale.y}ez({world_x:r.position.x,world_y:r.position.y,zoom:r.scale.x}),eC();return}if("Backspace"!==e.key&&"Delete"!==e.key||r)return;let n=T.current;if(!n||0===n.length)return;e.preventDefault();let i=eh.current??[],l=new Set(n),s=i.filter(e=>l.has(e.id)&&"image"===e.type);if(s.length>0){let e=new Set;for(let t of s)t.asset_id&&e.add(t.asset_id);let t=new Set;for(let e of i)!l.has(e.id)&&"image"===e.type&&e.asset_id&&t.add(e.asset_id);let r=[...e].filter(e=>!t.has(e)),n=r.length>0?`Delete ${s.length} image(s) from the board?

This will also permanently delete ${r.length} asset(s) from the project because nothing else is using them.`:`Delete ${s.length} image(s) from the board?`;if(!window.confirm(n))return}K([]);let o=null,c=[];W(e=>{let t=new Set(n),r=e.filter(e=>!t.has(e.id)),i=new Set;for(let r of e)t.has(r.id)&&"image"===r.type&&r.asset_id&&i.add(r.asset_id);let a=new Set;for(let e of r)"image"===e.type&&e.asset_id&&a.add(e.asset_id);return c=[...i].filter(e=>!a.has(e)),o=r,e_(r),r}),window.setTimeout(async()=>{if(o&&(await eN(o),eC(),c.length)){for(let e of c)await fetch(`/api/assets/${e}`,{method:"DELETE"}).catch(()=>{});J(e=>e.filter(e=>!c.includes(e.id)))}},0)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{let e=c.current;if(!e||d.current)return;let t=new a.lgM;return d.current=t,(async()=>{e.style.backgroundColor=v,await t.init({resizeTo:e,background:v,antialias:!0,autoDensity:!0,resolution:window.devicePixelRatio||1}),e.appendChild(t.canvas);let r=new a.mcf;h.current=r,r.filterArea=t.screen,t.stage.addChild(r);let n=new a.mcf;n.sortableChildren=!0,u.current=n,r.addChild(n);let i=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;

    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}`,s=`
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;

uniform float uTime;
uniform vec2 uCenter;     // 0..1 within filterArea (screen-space)
uniform float uAmplitude; // UV offset scale
uniform float uFrequency; // wave frequency
uniform float uSpeed;     // ring expansion speed (in UV/sec)
uniform float uWidth;     // ring thickness (in UV)
uniform float uDecay;     // spatial decay
uniform float uAspect;    // width/height
uniform float uShapeAspect;   // image aspect (w/h) for elliptical ripples
uniform float uShapeRotation; // radians (align ellipse to image rotation)
uniform float uDuration;  // seconds

float heightAt(float dist, float radius, float w, float timeFade, float distFade)
{
    float x = dist - radius;

    // Front band: a smooth "impact ring".
    float frontBand = exp(-(x * x) / (w * w));

    // Behind band: trailing ripples that decay behind the front.
    float behindBand = step(x, 0.0) * exp(x / (w * 2.0));

    // Ahead of the front, fade out quickly.
    float aheadFade = smoothstep(w * 3.0, 0.0, x);

    float band = (0.25 * frontBand + 0.75 * behindBand) * aheadFade;

    // Two harmonics reads as "watery" vs a single sine.
    float phase = x * uFrequency;
    float wave = sin(phase) + 0.35 * sin(phase * 2.15 + 1.3);

    // Global gain (keeps the effect subtle even with higher frequency content).
    return wave * band * timeFade * distFade * 0.35;
}

void main()
{
    vec2 uv = vTextureCoord;
    vec2 pUv = uv - uCenter;
    // Convert to screen-corrected space (so circles are circles on screen).
    vec2 pScreen = pUv;
    pScreen.x *= uAspect;

    // Rotate into the image-aligned frame.
    float cs = cos(uShapeRotation);
    float sn = sin(uShapeRotation);
    mat2 rot = mat2(cs, -sn, sn, cs);
    vec2 pr = rot * pScreen;

    // Elliptical metric based on the image aspect ratio (w/h).
    float sAspect = max(uShapeAspect, 0.0001);
    vec2 pm = vec2(pr.x / sAspect, pr.y);
    float dist = length(pm);

    float timeFade = clamp(1.0 - (uTime / max(uDuration, 0.001)), 0.0, 1.0);
    float distFade = exp(-uDecay * dist);

    float radius = uTime * uSpeed;
    float w = max(uWidth, 0.0005);

    // Radial direction in UV space for an ellipse:
    // - compute direction in metric space (pm), then map back to UV.
    vec2 dm = dist > 0.00001 ? (pm / dist) : vec2(0.0, 0.0);
    vec2 dr = vec2(dm.x * sAspect, dm.y); // undo metric scaling (back to rotated screen space)
    mat2 rotInv = mat2(cs, sn, -sn, cs);
    vec2 dScreen = rotInv * dr;
    vec2 dir = dScreen;
    dir.x /= max(uAspect, 0.00001);
    float dirLen = length(dir);
    dir = dirLen > 0.00001 ? (dir / dirLen) : vec2(0.0, 0.0);

    // Finite-difference slope -> "refraction normal" feel.
    float eps = 0.004;
    float h0 = heightAt(dist, radius, w, timeFade, distFade);
    float h1 = heightAt(dist + eps, radius, w, timeFade, distFade);
    float h2 = heightAt(max(0.0, dist - eps), radius, w, timeFade, distFade);
    float dh = (h1 - h2) / (2.0 * eps);
    float dhClamped = clamp(dh, -1.0, 1.0);
    float hClamped = clamp(h0, -1.0, 1.0);

    // Refraction: use slope + a tiny rotational component.
    vec2 perp = vec2(-dir.y, dir.x);
    vec2 disp = (dir * dhClamped + perp * (hClamped * 0.08)) * uAmplitude;

    vec2 uv2 = uv + disp;
    uv2 = clamp(uv2, vec2(0.0), vec2(1.0));

    finalColor = texture(uTexture, uv2);
}`,o=new a.k2S({uTime:{value:0,type:"f32"},uCenter:{value:new a.bRX(.5,.5),type:"vec2<f32>"},uAmplitude:{value:.0026,type:"f32"},uFrequency:{value:28,type:"f32"},uSpeed:{value:.36,type:"f32"},uWidth:{value:.18,type:"f32"},uDecay:{value:1.4,type:"f32"},uAspect:{value:1,type:"f32"},uShapeAspect:{value:1,type:"f32"},uShapeRotation:{value:0,type:"f32"},uDuration:{value:1.85,type:"f32"}});F.current={filter:new a.dJT({glProgram:a.M2g.from({vertex:i,fragment:s,name:"workspace-ripple-filter"}),resources:{rippleUniforms:o},padding:0}),uniforms:o,active:!1,timeSec:0};let c=new a.mcf,d=new a.mcf;c.addChild(d),$.current={rt:a.Y7R.create({width:256,height:256,resolution:1}),root:c,content:d,spriteById:new Map};let m=et.current??l;if(m){n.position.set(m.world_x,m.world_y);let e=Number.isFinite(m.zoom)?m.zoom:1;n.scale.set(j(e,.01,1))}let x=new a.mcf;x.eventMode="none",x.visible=!1,x.alpha=0,t.stage.addChild(x);let w=new a.A1g;M(w,ef.current),x.addChild(w);let y=new a.A1g;y.roundRect(0,0,220,160,10),y.fill(0xffffff),y.visible=!0,x.addChild(y);let b=new a.mcf;b.mask=y,x.addChild(b);let _=new a.mcf;b.addChild(_);let N=new a.A1g;b.addChild(N);let I=new a.A1g;b.addChild(I);let L=new a.A1g;b.addChild(L),U.current={container:x,bg:w,items:_,spriteById:new Map,shade:N,overlay:I,viewport:L,showUntilMs:0,targetAlpha:0},M(w,ef.current);let D=new a.mcf;D.zIndex=1e9,B.current=D,n.addChild(D);let H=new a.A1g;P.current=H,D.addChild(H);let q=new a.A1g;q.eventMode="none",q.zIndex=0x3b9ac9ff,V.current=q,n.addChild(q);let J=e=>{let t=new a.A1g;return t.eventMode="static",t.cursor="nwse-resize",t.__handle={corner:e},D.addChild(t),t};O.current={tl:J("tl"),tr:J("tr"),br:J("br"),bl:J("bl")};let Y=new a.bRX(0,0),G=(e,r)=>{let n=t.canvas.getBoundingClientRect(),i=(e-n.left)*t.renderer.width/n.width,l=(r-n.top)*t.renderer.height/n.height;return new a.bRX(i,l)},Q=(e,t)=>({tl:new a.bRX(-e/2,-t/2),tr:new a.bRX(e/2,-t/2),br:new a.bRX(e/2,t/2),bl:new a.bRX(-e/2,t/2)});t.canvas.addEventListener("pointerdown",e=>{t.canvas.setPointerCapture(e.pointerId),eS(null),Y=G(e.clientX,e.clientY);let r=t.renderer.events.rootBoundary.hitTest(Y.x,Y.y),n=1===T.current.length?T.current[0]:null;if(r&&r.__handle&&n){let e=r.__handle.corner,t=f.current.get(n),i=t?.texture?.orig?.width??0,l=t?.texture?.orig?.height??0;if(t&&i>0&&l>0){let r=Q(i,l),s="tl"===e?"br":"tr"===e?"bl":"br"===e?"tl":"tr",o=r[e],c=r[s];X.current={kind:"resize",objectId:n,corner:e,fixedWorld:new a.bRX(t.position.x+t.scale.x*c.x,t.position.y+t.scale.y*c.y),localFixed:c,localHandle:o,baseW:i,baseH:l};return}}if(r&&r.__objectId){let t,n=r.__objectId,i=e.shiftKey,a=T.current??[];if(i){let e=new Set(a);e.has(n)?e.delete(n):e.add(n),t=Array.from(e)}else t=[n];K(t),W(e=>{let r=function(e,t){if(!t.length)return e;let r=new Set(t),n=[...e].sort((e,t)=>e.z_index!==t.z_index?e.z_index-t.z_index:e.id.localeCompare(t.id)),i=[...n.filter(e=>!r.has(e.id)),...n.filter(e=>r.has(e.id))],a=new Date().toISOString();return i.map((e,t)=>e.z_index===t?e:{...e,z_index:t,updated_at:a})}(e,t);return e_(r),eM(r),r});let l=T.current,s=l&&l.length>0&&(i||l.includes(n))&&l.includes(n)?l:[n];X.current={kind:"move",objectIds:t.length?t:s,last:Y},eT(t.length?t:s,1);return}e.shiftKey||K([]),X.current={kind:"pan",last:Y}}),t.canvas.addEventListener("pointermove",e=>{let r=X.current;if(!r){let r=G(e.clientX,e.clientY),n=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(n&&n.__handle)return void eS(null);let i=(n&&n.__objectId?n.__objectId:null)??null;return void(i&&C.current.has(i)?eS(i):eS(null))}let i=G(e.clientX,e.clientY);if("pan"===r.kind){Z();let e=i.x-r.last.x,t=i.y-r.last.y;n.position.x+=e,n.position.y+=t,X.current={kind:"pan",last:i},ez({world_x:n.position.x,world_y:n.position.y,zoom:n.scale.x});return}if("move"===r.kind){let e=r.objectIds.map(e=>[e,f.current.get(e)]).filter(([,e])=>!!e);if(0===e.length)return;let t=i.x-r.last.x,a=i.y-r.last.y,l=1/(n.scale.x||1);for(let[r,n]of e){n.position.x+=t*l,n.position.y+=a*l;let e=p.current.get(r);e&&(e.position.x=n.position.x,e.position.y=n.position.y)}X.current={kind:"move",objectIds:r.objectIds,last:i},W(t=>{let r=new Map(e),n=t.map(e=>{let t=r.get(e.id);return t?{...e,x:t.position.x,y:t.position.y,updated_at:new Date().toISOString()}:e});return e_(n),eM(n),n});return}if("resize"===r.kind){let e=f.current.get(r.objectId);if(!e)return;let t=n.toLocal(i),a=t.x-r.fixedWorld.x,l=t.y-r.fixedWorld.y,s=r.localHandle.x-r.localFixed.x,o=r.localHandle.y-r.localFixed.y,c=a/s,d=l/o,u=Math.max(Math.abs(c),Math.abs(d));c=u,d=u,c=Math.max(.05,c),d=Math.max(.05,d),e.scale.set(c,d),e.position.x=r.fixedWorld.x-c*r.localFixed.x,e.position.y=r.fixedWorld.y-d*r.localFixed.y,W(t=>{let n=t.map(t=>t.id===r.objectId?{...t,x:e.position.x,y:e.position.y,scale_x:e.scale.x,scale_y:e.scale.y,width:r.baseW*e.scale.x,height:r.baseH*e.scale.y,updated_at:new Date().toISOString()}:t);return e_(n),eM(n),n})}}),t.canvas.addEventListener("pointerup",()=>{let e=X.current;e&&"move"===e.kind&&eT(e.objectIds,0),X.current=null,eC()}),t.canvas.addEventListener("wheel",e=>{let t;e.preventDefault(),Z();let r=G(e.clientX,e.clientY),i=n.toLocal(r),a=Math.pow(1.16,(e.deltaY>0?-1:1)*j(Math.abs(1===e.deltaMode?16*e.deltaY:2===e.deltaMode?800*e.deltaY:e.deltaY)/100,.35,6)),l=n.scale.x,s=.12+(t=j(a>1?(1-l)/.99:(l-.01)/.99,0,1))*t*(3-2*t)*.88,o=j(l+(l*a-l)*s,.01,1);n.scale.set(o);let c=n.toLocal(r);n.position.x+=(c.x-i.x)*n.scale.x,n.position.y+=(c.y-i.y)*n.scale.y,ez({world_x:n.position.x,world_y:n.position.y,zoom:n.scale.x}),eC()},{passive:!1}),t.canvas.addEventListener("contextmenu",e=>e.preventDefault()),t.canvas.addEventListener("pointerleave",()=>eS(null)),t.canvas.addEventListener("dblclick",e=>{if(X.current)return;let r=G(e.clientX,e.clientY),n=t.renderer.events.rootBoundary.hitTest(r.x,r.y);if(!n||n.__handle)return;let i=n.__objectId;if(!i)return;let a=eh.current.find(e=>e.id===i);if(!a||"image"!==a.type||!a.asset_id)return;let l=f.current.get(i),s=t.canvas.getBoundingClientRect(),o=null;if(l&&s.width>0&&s.height>0&&t.renderer.width>0&&t.renderer.height>0)try{let e=l.getBounds(),r=s.left+e.x/t.renderer.width*s.width,n=s.top+e.y/t.renderer.height*s.height,i=e.width/t.renderer.width*s.width,a=e.height/t.renderer.height*s.height;Number.isFinite(r)&&Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(a)&&i>2&&a>2&&(o={left:r,top:n,width:i,height:a})}catch{o=null}ec(o),ee(a.asset_id)});let Z=()=>{let e=U.current;e&&(e.showUntilMs=performance.now()+2500,e.targetAlpha=1,e.container.visible=!0)};t.ticker.add(e=>{let i=F.current;if(i&&i.active){i.timeSec+=(e.deltaMS??16.6667)/1e3,i.uniforms.uniforms.uTime=i.timeSec,i.uniforms.uniforms.uAspect=t.renderer.width/Math.max(1,t.renderer.height);let n=Number(i.uniforms.uniforms.uDuration)||1;i.timeSec>=n&&(i.active=!1,i.timeSec=0,r.filters&&r.filters.includes(i.filter)&&(r.filters=r.filters.filter(e=>e!==i.filter)),r.filters&&0===r.filters.length&&(r.filters=[]))}let l=E.current;if(l.size)for(let e of[...l]){let t=A.current.get(e);if(!t){l.delete(e);continue}let r=t.target-t.current;t.current+=.12*r,.001>Math.abs(r)&&(t.current=t.target,l.delete(e));let n=f.current.get(e),i=p.current.get(e);if(!n||!i)continue;let a=n.texture?.orig?.width??0,s=n.texture?.orig?.height??0;if(a<=0||s<=0)continue;let o=Math.min(22,a/2,s/2);z(i,a,s,o,t.current)}(()=>{let e=B.current,t=P.current;if(!e||!t)return;let r=O.current,n=T.current,i=1===n.length?n[0]:null,a=i?f.current.get(i):null,l=a?.texture?.orig?.width??0,s=a?.texture?.orig?.height??0;if(!a||l<=0||s<=0){e.visible=!1;return}e.visible=!0,e.position.set(a.position.x,a.position.y),e.rotation=a.rotation,e.scale.set(a.scale.x,a.scale.y),t.clear(),t.rect(-l/2,-s/2,l,s),t.stroke({width:2/Math.max(1e-4,a.scale.x),color:6333946,alpha:.9});let o=10/Math.max(1e-4,a.scale.x),c=Q(l,s);for(let e of["tl","tr","br","bl"]){let t=r[e];t&&(t.clear(),t.rect(c[e].x-o/2,c[e].y-o/2,o,o),t.fill(0xf8fafc),t.stroke({width:1/Math.max(1e-4,a.scale.x),color:2042167,alpha:.9}),t.__handle={corner:e})}})(),(()=>{let e=V.current;if(!e)return;let t=T.current;if(!t||t.length<=1)return e.clear();let r=n.scale.x||1,i=2/Math.max(1e-4,r),a=6/Math.max(1e-4,r),l=2/Math.max(1e-4,r);for(let r of(e.clear(),t)){let t=f.current.get(r);if(!t)continue;let n=t.texture?.orig?.width??0,s=t.texture?.orig?.height??0;if(n<=0||s<=0)continue;let o=n*t.scale.x/2+l,c=s*t.scale.y/2+l,d=Math.cos(t.rotation),u=Math.sin(t.rotation),h=(e,r)=>({x:t.position.x+e*d-r*u,y:t.position.y+e*u+r*d}),m=h(-o,-c),p=h(o,-c),x=h(o,c),w=h(-o,c);e.lineStyle(a,6333946,.22),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(w.x,w.y),e.lineTo(m.x,m.y),e.lineStyle(i,6333946,.98),e.moveTo(m.x,m.y),e.lineTo(p.x,p.y),e.lineTo(x.x,x.y),e.lineTo(w.x,w.y),e.lineTo(m.x,m.y)}})(),(()=>{let e=U.current;if(!e)return;if(e.container.position.set(t.renderer.width-220-12,t.renderer.height-160-12),performance.now()>e.showUntilMs&&(e.targetAlpha=0),e.container.alpha+=(e.targetAlpha-e.container.alpha)*.18,e.container.alpha<.02&&0===e.targetAlpha){e.container.visible=!1;return}if(!e.container.visible)return;let r=n.toLocal(new a.bRX(0,0)),i=n.toLocal(new a.bRX(t.renderer.width,t.renderer.height)),l=Math.min(r.x,i.x),s=Math.max(r.x,i.x),o=Math.min(r.y,i.y),c=Math.max(r.y,i.y);for(let e of f.current.values()){let t=e.texture?.orig?.width??0,r=e.texture?.orig?.height??0;if(t<=0||r<=0)continue;let n=t/2*e.scale.x,i=r/2*e.scale.y;l=Math.min(l,e.position.x-n),s=Math.max(s,e.position.x+n),o=Math.min(o,e.position.y-i),c=Math.max(c,e.position.y+i)}let d=Math.max(10,.06*Math.max(s-l,c-o));l-=d,s+=d,o-=d,c+=d;let u=Math.max(1,s-l),h=Math.max(1,c-o),m=Math.min(200/u,140/h),p=10+(200-u*m)/2,x=10+(140-h*m)/2,w=e=>p+(e-l)*m,g=e=>x+(e-o)*m,y=new Set,v=new Set(T.current??[]);for(let t of f.current.values()){let r=t.__objectId;if(!r)continue;let n=t.texture,i=n?.orig?.width??0,l=n?.orig?.height??0;if(i<=0||l<=0)continue;y.add(r);let s=e.spriteById.get(r);s?s.texture!==n&&(s.texture=n):((s=new a.kxk(n)).anchor.set(.5),s.eventMode="none",e.items.addChild(s),e.spriteById.set(r,s)),s.position.set(w(t.position.x),g(t.position.y)),s.scale.set(t.scale.x*m,t.scale.y*m),s.rotation=t.rotation,s.alpha=v.has(r)?1:.92}for(let[t,r]of e.spriteById.entries())y.has(t)||(r.destroy({children:!1}),e.spriteById.delete(t));if(e.overlay.clear(),v.size>0)for(let t of(e.overlay.lineStyle(2,0xfbbf24,.95),v)){let r=f.current.get(t);if(!r)continue;let n=r.texture,i=n?.orig?.width??0,a=n?.orig?.height??0;if(i<=0||a<=0)continue;let l=i*r.scale.x*m,s=a*r.scale.y*m,o=w(r.position.x),c=g(r.position.y);e.overlay.drawRect(o-l/2,c-s/2,l,s)}e.viewport.clear();let b=w(r.x),_=g(r.y),M=w(i.x),N=g(i.y),z=Math.min(b,M),C=Math.min(_,N),k=Math.abs(M-b),S=Math.abs(N-_),R=210,I=150,A=j(z,10,210),E=j(C,10,I),F=j(z+k,10,R),L=j(C+S,10,I),D=Math.min(A,F),$=Math.min(E,L),B=Math.max(0,Math.abs(F-A)),P=Math.max(0,Math.abs(L-E)),O=Math.min(j(.14*Math.min(B,P),3,10),B/2,P/2);e.shade.clear(),e.shade.beginFill(0,em.current),e.shade.drawRect(10,10,200,Math.max(0,$-10)),e.shade.drawRect(10,$+P,200,Math.max(0,I-($+P))),e.shade.drawRect(10,$,Math.max(0,D-10),P),e.shade.drawRect(D+B,$,Math.max(0,R-(D+B)),P),e.shade.endFill(),e.viewport.beginFill(6333946,.07),e.viewport.roundRect(D,$,B,P,O),e.viewport.endFill();let V=Math.max(0,B-6),X=Math.max(0,P-6);V>0&&X>0&&(e.viewport.lineStyle(6,6333946,.22),e.viewport.roundRect(D+3,$+3,V,X,Math.max(0,O-3)));let H=Math.max(0,B-2),W=Math.max(0,P-2);H>0&&W>0&&(e.viewport.lineStyle(2,6333946,1),e.viewport.roundRect(D+1,$+1,H,W,Math.max(0,O-1)))})();let s=S.current;if(s){let e=f.current.get(s),t=k.current.get(s);if(e&&t){let r=Number(e.texture?.orig?.width??0),n=Number(e.texture?.orig?.height??0);if(r>0&&n>0){let e=g.current.get(s)??null;if(e&&(e.loop=!0,!Number(R.current.get(s)??0))){R.current.set(s,Date.now());try{e.currentTime=0}catch{}e.play().catch(()=>{})}let i=e&&Number.isFinite(e.duration)?Number(e.duration):0,a=e&&Number.isFinite(e.currentTime)?Number(e.currentTime):0,l=i>0?j(a/i,0,1):0,o=Math.min(r,n),c=j(.065*o,10,22),d=j(.045*o,4,10),u=Math.max(10,r-2*c),h=-u/2,f=n/2-c-d,m=Math.min(d/2,6);t.visible=!0,t.clear(),t.roundRect(h,f,u,d,m),t.fill({color:0,alpha:.42}),t.roundRect(h,f,u,d,m),t.stroke({width:1,color:0xffffff,alpha:.1});let p=u*l;if(p>.75){let e=Math.min(m,p/2);t.roundRect(h,f,p,d,e),t.fill({color:6333946,alpha:.92})}}else t.visible=!1}}}),eA(n),eC()})(),()=>{}},[e.projectId]),(0,i.useEffect)(()=>{e.onFocusRequest?.(e=>{let t=u.current,r=d.current;if(!t||!r)return;let n=f.current.get(e);if(!n)return;let i=n.position,a=function(e,t,r,n){let i=e.texture?.orig?.width??0,a=e.texture?.orig?.height??0;if(i<=0||a<=0||t<=0||r<=0)return null;let l=Math.abs(i*(e.scale?.x??1)),s=Math.abs(a*(e.scale?.y??1));if(l<=0||s<=0)return null;let o=e.rotation??0,c=Math.abs(Math.cos(o)),d=Math.abs(Math.sin(o)),u=c*l+d*s,h=d*l+c*s;if(u<=0||h<=0)return null;let f=j(.88,.1,.98);return j(Math.min(t*f/u,r*f/h),.01,1)}(n,r.renderer.width,r.renderer.height,0)??t.scale.x;(t.scale.x!==a||t.scale.y!==a)&&t.scale.set(a),t.position.x=r.renderer.width/2-i.x*a,t.position.y=r.renderer.height/2-i.y*a,K([e]),ez({world_x:t.position.x,world_y:t.position.y,zoom:a})}),e.onViewportCenterRequest?.(()=>{let e=u.current,t=d.current;if(!e||!t)return{x:0,y:0};let r=new a.bRX(t.renderer.width/2,t.renderer.height/2),n=e.toLocal(r);return{x:n.x,y:n.y}})},[e.projectId]),(0,i.useEffect)(()=>{let e=u.current;e&&eA(e)},[H,ek]);let eA=e=>{let t=new Set(H.map(e=>e.id));for(let[e,r]of f.current.entries())t.has(e)||(r.destroy({children:!0}),f.current.delete(e),g.current.delete(e),C.current.delete(e),k.current.delete(e),A.current.delete(e),E.current.delete(e));for(let[e,r]of p.current.entries())t.has(e)||(r.destroy({children:!0}),p.current.delete(e),g.current.delete(e),C.current.delete(e),k.current.delete(e),A.current.delete(e),E.current.delete(e));for(let t of H){if(f.current.has(t.id)){let e=f.current.get(t.id);e.position.set(t.x,t.y),e.scale.set(t.scale_x,t.scale_y),e.rotation=t.rotation,e.zIndex=t.z_index,N(e);let r=p.current.get(t.id);r&&(r.position.set(t.x,t.y),r.scale.set(t.scale_x,t.scale_y),r.rotation=t.rotation,r.zIndex=t.z_index-.25,A.current.has(t.id)||A.current.set(t.id,{current:0,target:0}));continue}if("image"===t.type&&t.asset_id){var r;let n=ek.get(t.asset_id);if(!n)continue;let i=new a.A1g;i.eventMode="none",i.position.set(t.x,t.y),i.scale.set(t.scale_x,t.scale_y),i.rotation=t.rotation,i.zIndex=t.z_index-.25,i.__objectId=t.id,p.current.set(t.id,i),A.current.set(t.id,{current:0,target:0}),e.addChild(i);let l=new a.kxk(a.gPd.EMPTY);if(l.eventMode="static",l.cursor="move",l.anchor.set(.5),l.position.set(t.x,t.y),l.scale.set(t.scale_x,t.scale_y),l.rotation=t.rotation,l.zIndex=t.z_index,l.__objectId=t.id,f.current.set(t.id,l),e.addChild(l),(r=n.mime_type)&&r.startsWith("video/")){C.current.add(t.id);let e=new a.A1g;e.eventMode="none",e.visible=!1,k.current.set(t.id,e),l.addChild(e)}else C.current.delete(t.id);let s=n.storage_url,o=s.startsWith("http")?s:new URL(s,window.location.href).toString(),c=x.current.get(o);if(c){l.texture=c,N(l);let e=_(l.texture);e?g.current.set(t.id,e):g.current.delete(t.id);let r=l.texture?.orig?.width??0,n=l.texture?.orig?.height??0;if(r>0&&n>0){let e=Math.min(22,r/2,n/2);z(i,r,n,e,A.current.get(t.id)?.current??0)}eu(t.id,l.texture);continue}let d=w.current.get(o)??a.sP.load(o).then(e=>(x.current.set(o,e),e)).catch(e=>{throw console.error("pixi_texture_load_failed",o,e),e}).finally(()=>{w.current.delete(o)});w.current.set(o,d),d.then(e=>{let r=f.current.get(t.id);if(r){r.texture=e,N(r);let n=_(r.texture);n?g.current.set(t.id,n):g.current.delete(t.id);let i=r.texture?.orig?.width??0,a=r.texture?.orig?.height??0;if(i>0&&a>0){let e=Math.min(22,i/2,a/2),r=p.current.get(t.id),n=A.current.get(t.id)?.current??0;r&&z(r,i,a,e,n)}eu(t.id,r.texture)}}).catch(()=>{})}}},eE=async t=>{let r;t.preventDefault(),Q(null);let n=d.current,i=u.current;if(!n||!i)return;let l=Array.from(t.dataTransfer.files||[]);if(0===l.length)return;let s=n.canvas.getBoundingClientRect(),o=(t.clientX-s.left)*n.renderer.width/s.width,c=(t.clientY-s.top)*n.renderer.height/s.height,h=i.toLocal(new a.bRX(o,c)),f=new FormData;for(let e of l)f.append("files",e,e.name);try{r=await fetch(`/api/projects/${e.projectId}/assets/upload`,{method:"POST",body:f})}catch(e){console.error("upload_failed(fetch)",e),Q("Upload failed (network). If you restarted dev server, refresh the page.");return}if(!r.ok){let e=await r.text().catch(()=>"");console.error("upload_failed(response)",r.status,e),Q(`Upload failed (${r.status}).`);return}let m=(await r.json()).assets||[];J(e=>{let t=[...m,...e],r=new Set;return t.filter(e=>!r.has(e.id)&&(r.add(e.id),!0))});let p=m.map(()=>globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`);p.length>0&&(D.current={objectId:p[0],rx:o,ry:c,fired:!1});let x=new Date().toISOString();W(t=>{let r=[...t],n=t.reduce((e,t)=>Math.max(e,t.z_index),0)+1;for(let t=0;t<m.length;t++){let i=m[t];r.push({id:p[t],project_id:e.projectId,type:"image",asset_id:i.id,x:h.x,y:h.y,scale_x:1,scale_y:1,rotation:0,width:i.width??null,height:i.height??null,z_index:n++,props_json:null,created_at:x,updated_at:x})}return e_(r),eM(r),r})};return(0,n.jsxs)("div",{ref:c,onDragOver:e=>e.preventDefault(),onDrop:eE,className:"relative h-full w-full",children:[!er.online||er.syncing||er.dirtyCanvas||er.dirtyView?(0,n.jsx)("div",{className:"pointer-events-none absolute left-4 top-4 z-50",children:(0,n.jsx)("div",{className:"rounded-full border px-3 py-1 text-[11px] font-medium "+(er.online?(er.syncing,"border-amber-900/40 bg-amber-950/35 text-amber-200"):"border-red-900/50 bg-red-950/50 text-red-200"),children:er.online?er.syncing?"Syncing…":"Unsynced":"Offline"})}):null,G?(0,n.jsx)("div",{className:"pointer-events-none absolute left-1/2 top-10 -translate-x-1/2 rounded-lg border border-red-900/50 bg-red-950/60 px-3 py-2 text-xs text-red-200",children:G}):null,Z&&ek.get(Z)?(0,n.jsx)(s,{projectId:e.projectId,asset:ek.get(Z),originRect:eo,onClose:()=>ee(null)}):null]})}var k=r(5012);function S(e){let[t,r]=(0,i.useState)(!1),[a,l]=(0,i.useState)(""),[s,o]=(0,i.useState)([]),c=(0,i.useRef)(null),d=(0,i.useMemo)(()=>{let t=new Map;for(let r of e.objects)"image"===r.type&&r.asset_id&&t.set(r.asset_id,r.id);return t},[e.objects]);(0,i.useEffect)(()=>{let e=e=>{(navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey)&&"k"===e.key.toLowerCase()&&(e.preventDefault(),r(e=>!e)),"Escape"===e.key&&r(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,i.useEffect)(()=>{if(!t)return;let r=window.setTimeout(async()=>{let t=await fetch(`/api/projects/${e.projectId}/assets/search?q=${encodeURIComponent(a)}&limit=50&mode=hybrid`);t.ok&&o((await t.json()).assets??[])},120);return()=>window.clearTimeout(r)},[t,a,e.projectId]),(0,i.useEffect)(()=>{if(!t)return;let e=window.requestAnimationFrame(()=>{let e=c.current;e&&(e.focus(),e.select())});return()=>window.cancelAnimationFrame(e)},[t]);let u=t?s:[];return(0,n.jsxs)(n.Fragment,{children:[t?(0,n.jsx)("div",{className:"fixed inset-0 z-50 bg-black/40",onClick:()=>r(!1)}):null,(0,n.jsx)("div",{className:t?"fixed left-1/2 top-16 z-50 w-[720px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl":"hidden",children:(0,n.jsxs)(k.uB,{className:"flex flex-col overflow-hidden",children:[(0,n.jsx)("div",{className:"border-b border-zinc-900 p-3",children:(0,n.jsx)(k.uB.Input,{ref:c,autoFocus:!0,value:a,onValueChange:l,placeholder:"Search assets…",className:"w-full bg-transparent text-sm outline-none placeholder:text-zinc-600"})}),(0,n.jsxs)(k.uB.List,{className:"max-h-[420px] overflow-auto p-2",children:[(0,n.jsx)(k.uB.Empty,{className:"p-3 text-sm text-zinc-500",children:"No results."}),u.map(t=>{let i=d.get(t.id),l="done"===t.ai_status?t.ai_caption:t.ai_status?t.ai_status:"";return(0,n.jsxs)(k.uB.Item,{value:`${t.original_name} ${t.ai_caption??""}`,onSelect:()=>{r(!1),i?e.onFocusObjectId(i):e.onPlaceAssetAtViewportCenter(t.id);let n=a.trim().split(/\s+/g).filter(Boolean)[0]?.toLowerCase();!n||e.onHighlightAsset&&fetch(`/api/projects/${e.projectId}/assets/${t.id}/segments?term=${encodeURIComponent(n)}`).then(e=>e.ok?e.json():null).then(r=>{r&&e.onHighlightAsset?.({assetId:t.id,term:n,svg:r.svg??null,bboxJson:r.bboxJson??null})}).catch(()=>{})},className:"flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 aria-selected:bg-zinc-900",children:[(0,n.jsx)("div",{className:"h-10 w-10 shrink-0 rounded bg-zinc-900 overflow-hidden",children:t.thumb_url?(0,n.jsx)("img",{src:t.thumb_url,alt:"",className:"h-full w-full object-contain"}):null}),(0,n.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,n.jsx)("div",{className:"truncate",children:t.original_name}),l?(0,n.jsx)("div",{className:"truncate text-xs text-zinc-500",children:l}):null]})]},t.id)})]}),(0,n.jsx)("div",{className:"border-t border-zinc-900 p-2 text-xs text-zinc-500"})]})})]})}var R=r(5702),T=r(7650);function I(e){return"undefined"==typeof document?null:(0,T.createPortal)(e.children,document.body)}function A(e){let t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}}function E(e){let t,r=(0,R.useRouter)(),[a,l]=(0,i.useState)(!1),[s,o]=(0,i.useState)([]),[c,d]=(0,i.useState)(null),[u,h]=(0,i.useState)(null),[f,m]=(0,i.useState)(null),[p,x]=(0,i.useState)(null),w=(0,i.useRef)(null),g=(0,i.useRef)(null),[y,v]=(0,i.useState)(null),b=(0,i.useMemo)(()=>s.find(t=>t.id===e.currentProjectId)??null,[s,e.currentProjectId]),j=async()=>{let e=await fetch("/api/projects");e.ok&&o((await e.json()).projects??[])};(0,i.useEffect)(()=>{j()},[]),(0,i.useLayoutEffect)(()=>{a&&w.current&&m(A(w.current))},[a]),(0,i.useLayoutEffect)(()=>{u&&g.current&&x(A(g.current))},[u]);let _=async()=>{if(!y||"new"!==y.type)return;let e=y.name.trim();if(e){d("new");try{let t=await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!t.ok)return;let n=await t.json();await j(),l(!1),h(null),v(null),r.push(`/projects/${n.project.id}`)}finally{d(null)}}},M=async e=>{if(!y||"rename"!==y.type||y.project.id!==e.id)return;let t=y.name.trim();if(t){d(e.id);try{if(!(await fetch(`/api/projects/${e.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})})).ok)return;await j(),h(null),v(null)}finally{d(null)}}},N=async t=>{if(y&&"delete"===y.type&&y.project.id===t.id){d(t.id);try{if(!(await fetch(`/api/projects/${t.id}`,{method:"DELETE"})).ok)return;await j(),l(!1),h(null),v(null),t.id===e.currentProjectId&&r.push("/")}finally{d(null)}}};return(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsxs)("button",{ref:w,onClick:()=>{l(e=>!e),h(null)},className:"text"===e.variant?"inline-flex items-center gap-2 px-2 py-1 text-sm font-medium text-zinc-200 hover:text-zinc-50":"inline-flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 hover:bg-zinc-900",children:[(0,n.jsx)("span",{className:"max-w-[220px] truncate",children:b?.name??"Select project"}),(0,n.jsx)("span",{className:"text-zinc-500",children:"▾"})]}),(0,n.jsxs)(I,{children:[a&&f?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9998]",onMouseDown:()=>{l(!1),h(null)}}),(0,n.jsxs)("div",{className:"fixed z-[9999] w-[340px] rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl",style:{left:Math.max(8,Math.min(window.innerWidth-340-8,"center"===(t=e.align??"right")?f.left+f.width/2-170:"left"===t?f.left:f.left+f.width-340)),top:f.top+f.height+8},children:[(0,n.jsxs)("div",{className:"flex items-center justify-between border-b border-zinc-900 px-3 py-2",children:[(0,n.jsx)("div",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Projects"}),(0,n.jsx)("button",{onClick:()=>v({type:"new",name:"New project"}),disabled:"new"===c,className:"rounded-md bg-zinc-50 px-2 py-1 text-xs font-medium text-zinc-950 disabled:opacity-60",children:"New"})]}),(0,n.jsx)("div",{className:"max-h-[360px] overflow-auto",children:s.map(t=>{let i=t.id===e.currentProjectId,a=c===t.id;return(0,n.jsxs)("div",{className:`flex items-center gap-2 px-3 py-2 text-sm ${i?"bg-zinc-900/60":"hover:bg-zinc-900"}`,children:[(0,n.jsxs)("button",{disabled:a,onClick:()=>{l(!1),h(null),r.push(`/projects/${t.id}`)},className:"min-w-0 flex-1 text-left flex items-center gap-3",children:[(0,n.jsx)("div",{className:"h-12 w-12 shrink-0 overflow-hidden rounded-lg border border-white/10 bg-zinc-900",children:(0,n.jsx)("img",{src:`/files/projects/${t.id}/preview`,alt:"",className:"h-full w-full object-cover",onError:e=>{e.currentTarget.style.display="none"}})}),(0,n.jsx)("div",{className:"min-w-0 flex-1",children:(0,n.jsx)("div",{className:"truncate text-zinc-200",children:t.name})})]}),(0,n.jsx)("button",{ref:u?.id===t.id?g:null,disabled:a,onClick:e=>{e.stopPropagation(),h(e=>e?.id===t.id?null:t)},className:"rounded-md px-2 py-1 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200",title:"Project actions",children:"⋯"})]},t.id)})})]})]}):null,u&&p?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fixed inset-0 z-[9999]",onMouseDown:()=>h(null)}),(0,n.jsxs)("div",{className:"fixed z-[10000] w-40 rounded-lg border border-zinc-800 bg-zinc-950 shadow-xl overflow-hidden",style:{left:Math.min(window.innerWidth-168,p.left+p.width-160),top:p.top+p.height+6},children:[(0,n.jsx)("button",{onClick:()=>v({type:"rename",project:u,name:u.name}),className:"block w-full px-3 py-2 text-left text-sm text-zinc-200 hover:bg-zinc-900",children:"Rename…"}),(0,n.jsx)("button",{onClick:()=>v({type:"delete",project:u}),className:"block w-full px-3 py-2 text-left text-sm text-red-300 hover:bg-zinc-900",children:"Delete…"})]})]}):null,y?(0,n.jsxs)("div",{className:"fixed inset-0 z-[10001]",children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/50",onMouseDown:()=>v(null)}),(0,n.jsx)("div",{className:"absolute left-1/2 top-28 w-[420px] max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950 p-4 shadow-2xl",children:"delete"===y.type?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"Delete project?"}),(0,n.jsx)("div",{className:"mt-1 text-xs text-zinc-500",children:y.project.name}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>v(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>N(y.project),disabled:c===y.project.id,className:"rounded-md bg-red-500 px-3 py-2 text-sm font-medium text-white disabled:opacity-60",children:"Delete"})]})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-sm text-zinc-200",children:"new"===y.type?"New project":"Rename project"}),(0,n.jsx)("input",{autoFocus:!0,value:y.name,onChange:e=>{let t=e.target.value;v(e=>e&&("new"===e.type||"rename"===e.type)?{...e,name:t}:e)},className:"mt-3 w-full rounded-lg border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200 outline-none focus:border-zinc-600",placeholder:"Project name"}),(0,n.jsxs)("div",{className:"mt-4 flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>v(null),className:"rounded-md border border-zinc-800 bg-zinc-950 px-3 py-2 text-sm text-zinc-200",children:"Cancel"}),(0,n.jsx)("button",{onClick:()=>{"new"===y.type&&_(),"rename"===y.type&&M(y.project)},disabled:"new"===c||"rename"===y.type&&c===y.project.id,className:"rounded-md bg-zinc-50 px-3 py-2 text-sm font-medium text-zinc-950 disabled:opacity-60",children:"Save"})]})]})})]}):null]})]})}function F(e){let{project:t}=e,[r,a]=(0,i.useState)(e.initialObjects),[l,s]=(0,i.useState)(null),[o,c]=(0,i.useState)(null),[d,u]=(0,i.useState)(null);return(0,n.jsxs)("div",{className:"h-screen w-screen bg-zinc-950 text-zinc-50 overflow-hidden",children:[(0,n.jsx)(C,{projectId:t.id,initialAssets:e.initialAssets,initialObjects:r,initialView:e.initialView,highlightOverlay:l,onObjectsChange:a,onFocusRequest:e=>c(()=>e),onViewportCenterRequest:e=>u(()=>e)}),(0,n.jsx)("div",{className:"pointer-events-none absolute inset-x-0 top-0 z-40 h-14 bg-gradient-to-b from-black/50 to-transparent"}),(0,n.jsx)("div",{className:"absolute left-3 top-3 z-50",children:(0,n.jsx)(E,{currentProjectId:t.id,variant:"text",align:"left"})}),(0,n.jsx)(S,{projectId:t.id,objects:r,onFocusObjectId:e=>o?.(e),onPlaceAssetAtViewportCenter:async e=>{let n=d?.()??{x:0,y:0},i=[...r,{id:globalThis.crypto?.randomUUID?.()??`${Date.now()}-${Math.random()}`,project_id:t.id,type:"image",asset_id:e,x:n.x,y:n.y,scale_x:1,scale_y:1,rotation:0,width:null,height:null,z_index:r.reduce((e,t)=>Math.max(e,t.z_index),0)+1,props_json:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}];a(i),await fetch(`/api/projects/${t.id}/canvas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({objects:i})})},onHighlightAsset:e=>s(e)})]})}},945:(e,t,r)=>{Promise.resolve().then(r.bind(r,22))}},e=>{e.O(0,[679,441,794,358],()=>e(e.s=945)),_N_E=e.O()}]);